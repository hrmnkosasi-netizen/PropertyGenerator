<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgentPro v23.0 - Super Reels & AI</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- CSS UTAMA --- */
        :root {
            --primary: #FFD900; --text-on-primary: #000000; --accent: #111;
            --text-main: #1f2937; --bg-body: #f3f4f6; --bg-card: #ffffff;
            --lux-bg: #121212; --lux-gold: #d4af37; --lux-text: #f3f4f6;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: #e5e7eb; font-family: 'Plus Jakarta Sans', sans-serif; display: flex; justify-content: center; height: 100dvh; color: var(--text-main); }
        .mobile-frame { width: 100%; max-width: 480px; background: var(--bg-body); height: 100%; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.15); }
        
        /* HEADER */
        .header { padding: 12px 15px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; z-index: 50; flex-shrink: 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .header-left { display: flex; flex-direction: column; }
        .header h1 { margin: 0; font-size: 1rem; font-weight: 800; color: var(--accent); line-height: 1; }
        .header h1 span { color: var(--primary); }
        .user-greet { font-size: 0.7rem; color: #166534; font-weight: 700; cursor: pointer; margin-top: 2px; display: flex; align-items: center; gap: 4px; }
        
        .btn-group-head { display: flex; align-items: center; gap: 8px; }
        .btn-reset { border:none; background: #fee2e2; color:#ef4444; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:0.9rem;}
        .btn-lic { background: #fef3c7; color: #d97706; }
        
        .btn-buy-pro { 
            background: #25D366; color: white; border: none; padding: 6px 12px; 
            border-radius: 20px; font-size: 0.75rem; font-weight: 700; cursor: pointer; 
            display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(37, 211, 102, 0.3);
            animation: pulse 2s infinite; text-decoration: none;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* CONTENT */
        .content { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 15px; padding-bottom: 90px; }
        .section { display: none; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .section.active { display: block; }
        @keyframes slideUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }

        /* COPYRIGHT FOOTER */
        .copyright { text-align: center; font-size: 0.65rem; color: #9ca3af; margin-top: 30px; margin-bottom: 20px; font-weight: 500; }

        /* CARDS & FORMS */
        .card { background: var(--bg-card); padding: 15px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card-head { font-weight: 700; font-size: 0.85rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: var(--accent); padding-bottom: 8px; border-bottom: 1px dashed #e5e7eb; }
        .form-group { margin-bottom: 10px; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; min-width: 0; }
        label { display: block; font-size: 0.7rem; font-weight: 600; color: var(--text-muted); margin-bottom: 4px; margin-left: 2px;}
        input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid transparent; border-radius: 10px; font-size: 0.9rem; font-family: inherit; font-weight: 500; background: #f9fafb; color: var(--text-main); transition: 0.2s; }
        input:focus, select:focus, textarea:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,0,0, 0.1); }
        .hidden-input { display: none; }
        .pro-locked { position: relative; opacity: 0.6; pointer-events: none; filter: grayscale(1); }
        .input-group-locked { position: relative; }
        .lock-icon { position: absolute; right: 10px; top: 35px; color: #d97706; font-size: 0.9rem; z-index: 10; background: #fff; padding: 2px 6px; border-radius: 4px; border: 1px solid #eee; }

        /* MODALS */
        #aiModal, #projectModal, #buyModal, #paymentModal, #userProfileModal, #reelsModal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 250;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(3px); padding: 20px; overflow-y: auto;
        }
        #projectModal { z-index: 260; }
        #buyModal .ai-content { max-width: 440px; } 

        .ai-content {
            background: #fff; width: 100%; max-width: 400px;
            border-radius: 20px; padding: 25px;
            animation: zoomIn 0.2s; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-height: 90vh; overflow-y: auto;
        }
        @keyframes zoomIn { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        .ai-option { background: #f3f4f6; padding: 12px; border-radius: 10px; margin-bottom: 10px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: 0.2s; color:#333; }
        .ai-option:hover { background: #e0e7ff; color: #4338ca; }
        .ai-title { font-weight: 800; font-size: 1.1rem; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }

        /* PRICING TABLE */
        .pricing-grid { display: flex; gap: 10px; margin-top: 10px; }
        .pricing-col { flex: 1; border: 1px solid #eee; border-radius: 12px; padding: 15px 10px; text-align: center; position: relative; background: #f9fafb; }
        .pricing-col.pro { border: 2px solid var(--primary); background: #fff; box-shadow: 0 4px 15px rgba(255, 217, 0, 0.2); transform: scale(1.02); z-index: 2; }
        .best-value { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #000; font-size: 0.6rem; font-weight: 800; padding: 4px 8px; border-radius: 10px; white-space: nowrap; }
        .p-title { font-size: 0.9rem; font-weight: 800; color: #444; margin-bottom: 5px; }
        .p-price { font-size: 1.2rem; font-weight: 900; color: #111; margin-bottom: 10px; }
        .p-list { list-style: none; padding: 0; margin: 0 0 15px 0; text-align: left; font-size: 0.7rem; color: #666; }
        .p-list li { margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
        .p-btn { width: 100%; padding: 8px; border-radius: 8px; font-weight: 700; font-size: 0.75rem; cursor: pointer; border: none; }
        .btn-free { background: #e5e7eb; color: #444; }
        .btn-pro { background: #25D366; color: #fff; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3); animation: pulse 2s infinite;}

        /* USER PROFILE */
        .user-card-info { text-align: center; padding-bottom: 15px; border-bottom: 1px dashed #eee; margin-bottom: 15px; }
        .uc-avatar { width: 60px; height: 60px; background: #dcfce7; color: #166534; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 0 auto 10px auto; }
        .uc-name { font-weight: 800; font-size: 1.1rem; margin-bottom: 2px; }
        .uc-status { background: #000; color: #FFD900; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 800; display: inline-block; margin-bottom: 5px; }
        .uc-exp { font-size: 0.85rem; color: #15803d; font-weight: 600; }
        .btn-logout { background: #fee2e2; color: #ef4444; width: 100%; padding: 10px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; margin-top: 10px; }

        /* ACTION BUTTONS */
        .pay-box { background: #f0fdf4; border: 2px dashed #4ade80; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        .pay-rek { font-size: 1.3rem; font-weight: 800; letter-spacing: 1px; color: #15803d; margin: 10px 0; display: block; font-family: monospace; }
        .copy-btn { background: #fff; border: 1px solid #ddd; padding: 6px 15px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; color: #555; font-weight: 600; }
        .btn-action { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 12px; font-weight: 700; font-size: 0.9rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-share { background: #059669; margin-left:10px; flex:1; }
        .btn-ai-gen { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; padding: 10px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; width: 100%; justify-content: center; margin-top: 5px; }
        .btn-bulk { background: #e0f2fe; color: #0284c7; margin-bottom: 10px; border: 1px dashed #7dd3fc; }
        .btn-magic { background: linear-gradient(135deg, #ec4899, #8b5cf6); color: white; margin-top:15px; }

        /* UPLOAD GRID */
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .upload-box { aspect-ratio: 4/3; background: #e5e7eb; border-radius: 12px; overflow: hidden; position: relative; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .upload-box:active { transform: scale(0.98); } .upload-box img { width: 100%; height: 100%; object-fit: cover; display: none; } .upload-box.has-img img { display: block; } .upload-box.has-img .placeholder { display: none; }
        .upload-box .placeholder { color: #888; font-size: 0.75rem; text-align: center; font-weight: 500; } .upload-box .placeholder i { font-size: 1.5rem; display: block; margin-bottom: 6px; color: #aaa; }
        .upload-box .del-btn { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.6); color: white; width: 24px; height: 24px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 0.8rem; z-index: 5; } .upload-box.has-img .del-btn { display: flex; }
        .img-cover { width: 100%; height: 100%; object-fit: cover; }
        
        /* POSTER & CANVAS */
        .preview-container { width: 100%; display: flex; justify-content: center; align-items: flex-start; padding: 10px 0; overflow: hidden; }
        .poster-scaler { transform-origin: top center; transition: transform 0.3s ease; box-shadow: 0 20px 40px rgba(0,0,0,0.15); border-radius: 2px; }
        #posterCanvas { background: #fff; overflow: hidden; position: relative; display: flex; flex-direction: column; transition: background 0.3s; }
        #posterCanvas.feed { width: 360px; height: 450px; } #posterCanvas.story { width: 320px; height: 568px; }
        .canvas-img-area { position: relative; width: 100%; background: #eee; overflow: hidden; display: grid; gap: 2px; background: #fff; transition: background 0.3s; }
        #posterCanvas.feed .canvas-img-area { height: 70%; } #posterCanvas.story .canvas-img-area { height: 75%; }
        
        .layout-1 { grid-template-columns: 1fr; grid-template-rows: 1fr; } .layout-2 { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; } .layout-3 { grid-template-columns: 1fr 1fr; grid-template-rows: 2fr 1fr; } .layout-3 .grid-item:nth-child(1) { grid-column: 1 / 3; } .layout-4 { grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 2fr 1fr; } .layout-4 .grid-item:nth-child(1) { grid-column: 1 / 4; } 
        .grid-item { position: relative; overflow: hidden; background: #ddd; } .grid-item img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .price-badge-container { position: absolute; top: 20px; right: 0; z-index: 20; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); padding-right: 0; }
        .price-row { display: flex; align-items: stretch; border-radius: 8px 0 0 8px; overflow: hidden; height: 28px; }
        .pr-label { background: var(--primary); color: var(--text-on-primary); font-weight: 800; font-size: 0.6rem; padding: 0 8px; display: flex; align-items: center; text-transform: uppercase; } .pr-label.sewa { background: #f3f4f6; color: #111; }
        .pr-val { background: #fff; color: #000; font-weight: 800; font-size: 0.8rem; padding: 0 10px; display: flex; align-items: center; letter-spacing: -0.5px; }
        .price-strike { background: #ef4444; color: #fff; font-size: 0.6rem; font-weight: 700; padding: 2px 8px; border-radius: 6px 0 0 6px; text-decoration: line-through; margin-right: 0; margin-bottom: -4px; display: inline-block; }
        
        .status-badge { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); border: 6px solid #fff; padding: 10px 30px; font-size: 2.5rem; font-weight: 900; color: #fff; background: rgba(220, 38, 38, 0.8); text-transform: uppercase; letter-spacing: 3px; z-index: 15; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; }
        .watermark { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; pointer-events: none; z-index: 10; opacity: 0.25; }
        .watermark span { font-size: 2.2rem; font-weight: 800; color: #ffffff; letter-spacing: 0px; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-family: 'Plus Jakarta Sans', sans-serif; }

        .canvas-info-area { flex: 1; background: #fff; padding: 12px 15px; display: flex; flex-direction: column; justify-content: space-between; position: relative; z-index: 20; transition: background 0.3s, color 0.3s; }
        .prop-indicator { font-size: 0.65rem; font-weight: 800; color: var(--primary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 2px; display: flex; align-items: center; gap: 5px; }
        .info-title { font-weight: 900; font-size: 1rem; line-height: 1.1; text-transform: uppercase; color: #111; margin-bottom: 2px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; transition: color 0.3s; }
        .info-loc { font-size: 0.7rem; color: #666; display: flex; gap: 4px; align-items: center; font-weight: 500; margin-bottom: 8px;}
        
        .specs-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px 0; padding: 6px 0; margin: 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; transition: border-color 0.3s; }
        .spec-box { text-align: center; border-right: 1px solid #eee; padding: 2px 0; display: block; transition: border-color 0.3s;}
        .spec-val { font-weight: 800; font-size: 0.7rem; color: #222; display:flex; justify-content:center; gap:2px; align-items:center; } .spec-val i { font-size: 0.6rem; color: #999; }
        .spec-label { font-size: 0.45rem; color: #888; text-transform: uppercase; font-weight: 600; margin-top: 1px; letter-spacing: -0.2px; }

        .agent-bar { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-top: 6px; }
        .agent-profile { display: flex; align-items: center; gap: 8px; flex: 1; overflow: hidden; }
        .agent-pic-box { width: 38px; height: 38px; border-radius: 50%; border: 1px solid var(--primary); flex-shrink: 0; overflow: hidden; background: #eee; }
        .agent-text h4 { margin: 0; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; line-height: 1.1; }
        .agent-text p { margin: 1px 0 0 0; font-size: 0.6rem; color: #666; }
        .agent-phone { font-size: 0.7rem; color: #111; font-weight: 700; display: flex; align-items: center; gap: 4px; margin-top: 1px; } .agent-phone i { color: #25D366; }
        .qr-wrapper { width: 38px; height: 38px; padding: 2px; border: 1px solid #eee; border-radius: 4px; background:#fff; flex-shrink: 0;} .qr-wrapper img { width: 100%; height: 100%; object-fit: contain; }

        /* LUXURY THEME */
        #posterCanvas.luxury-theme .canvas-info-area { background: var(--lux-bg); color: var(--lux-text); }
        #posterCanvas.luxury-theme .canvas-img-area { background: var(--lux-bg); }
        #posterCanvas.luxury-theme .info-title { color: #fff; font-family: 'Playfair Display', serif; letter-spacing: 0.5px; }
        #posterCanvas.luxury-theme .prop-indicator { color: var(--lux-gold); }
        #posterCanvas.luxury-theme .info-loc { color: #888; } #posterCanvas.luxury-theme .info-loc i { color: var(--lux-gold) !important; }
        #posterCanvas.luxury-theme .specs-grid { border-color: #333; } #posterCanvas.luxury-theme .spec-box { border-color: #333; }
        #posterCanvas.luxury-theme .spec-val { color: var(--lux-gold); } #posterCanvas.luxury-theme .spec-val i { color: #666; } #posterCanvas.luxury-theme .spec-label { color: #888; }
        #posterCanvas.luxury-theme .agent-text h4 { color: #fff; } #posterCanvas.luxury-theme .agent-text p { color: #999; } #posterCanvas.luxury-theme .agent-phone { color: #eee; }
        #posterCanvas.luxury-theme .pr-label { background: linear-gradient(45deg, #d4af37, #fcd34d); color: #000; } #posterCanvas.luxury-theme .pr-val { background: #222; color: #d4af37; }

        /* REELS TAB */
        .reels-container { text-align: center; padding: 30px 20px; background: #fff; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .reels-icon { font-size: 3rem; color: var(--primary); margin-bottom: 15px; }
        .reels-desc { font-size: 0.85rem; color: #666; margin-bottom: 20px; line-height: 1.5; }
        #reelsPreview { width: 100%; max-width: 240px; aspect-ratio: 9/16; background: #000; margin: 0 auto 15px auto; border-radius: 12px; display: none; }

        /* NAVBAR */
        .nav-bar { position: absolute; bottom: 0; width: 100%; height: 70px; background: #fff; border-top: 1px solid #eee; display: flex; z-index: 40; padding-bottom: 10px; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.65rem; color: #9ca3af; cursor: pointer; transition: 0.2s; font-weight: 600; }
        .nav-btn.active { color: #111; } .nav-btn.active i { color: var(--primary); transform: translateY(-2px); } .nav-btn i { font-size: 1.2rem; margin-bottom: 4px; }
        
        .segment-control { display: flex; background: #e5e7eb; padding: 3px; border-radius: 10px; margin-bottom: 15px; }
        .segment-btn { flex: 1; padding: 8px; text-align: center; border: none; background: transparent; font-weight: 600; font-size: 0.8rem; cursor: pointer; border-radius: 8px; color: #666; transition: 0.2s; } .segment-btn.active { background: #fff; color: #000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cap-tools { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .cap-opt { background: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid #e5e7eb; } .cap-opt label { font-size: 0.7rem; color: #666; display: block; margin-bottom: 5px; } .cap-opt select, .cap-opt button { width: 100%; font-size: 0.8rem; padding: 6px; }
        .kpr-input-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .kpr-box { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 10px; border-radius: 8px; text-align: center; } .kpr-box label { color: #166534; font-size: 0.65rem; margin-bottom: 4px; display: block; } .kpr-box input { text-align: center; padding: 5px; font-weight: bold; color: #15803d; border: 1px solid #86efac; background: #fff; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px); background: #111; color: #fff; padding: 8px 20px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; opacity: 0; transition: 0.4s; z-index: 100; pointer-events: none; display: flex; align-items: center; gap: 8px; } .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 300; display: none; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .slider-box { background: #fff; padding: 10px 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
    <div style="font-weight: 600;" id="loadingText">Memproses...</div>
</div>

<div id="aiModal" onclick="closeModal('aiModal')">
    <div class="ai-content" onclick="event.stopPropagation()">
        <div class="ai-title">
            <span>‚ú® Pilih Judul AI (Random)</span>
            <span onclick="closeModal('aiModal')" style="cursor:pointer;">&times;</span>
        </div>
        <div id="aiList"></div>
    </div>
</div>

<div id="projectModal" onclick="closeModal('projectModal')">
    <div class="ai-content" onclick="event.stopPropagation()">
        <div class="ai-title">
            <span>üìÇ Kelola Listing</span>
            <span onclick="closeModal('projectModal')" style="cursor:pointer;">&times;</span>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="saveName" placeholder="Nama Listing (Cth: Rumah BSD)" style="border:1px solid #ccc;">
            <button class="btn-ai-gen" onclick="saveCurrentProject()" style="width:auto; margin:0;"><i class="fas fa-save"></i> Save</button>
        </div>
        <hr style="border:0; border-top:1px dashed #ddd; margin-bottom:15px;">
        <div id="projectList" style="max-height:300px; overflow-y:auto;">
            <div style="text-align:center; color:#999; padding:20px;">Belum ada listing tersimpan</div>
        </div>
    </div>
</div>

<div id="buyModal" onclick="closeModal('buyModal')">
    <div class="ai-content" onclick="event.stopPropagation()">
        
        <div id="step-pricing">
            <div class="ai-title">
                <span>üíé Pilih Paket</span>
                <span onclick="closeModal('buyModal')" style="cursor:pointer;">&times;</span>
            </div>
            
            <div class="pricing-grid">
                <div class="pricing-col">
                    <div class="p-title">STARTER</div>
                    <div class="p-price">Rp 0</div>
                    <ul class="p-list">
                        <li>‚ùå Watermark</li>
                        <li>‚ùå AI Judul</li>
                        <li>‚ùå Luxury Style</li>
                        <li>‚úÖ Basic Edit</li>
                    </ul>
                    <button class="p-btn btn-free" onclick="closeModal('buyModal')">Lanjutkan</button>
                </div>
                
                <div class="pricing-col pro">
                    <div class="best-value">BEST VALUE</div>
                    <div class="p-title">PRO MEMBER</div>
                    <div class="p-price">Rp 50rb<span style="font-size:0.6rem; font-weight:400">/bln</span></div>
                    <ul class="p-list">
                        <li>‚úÖ No Watermark</li>
                        <li>‚úÖ AI Auto Judul</li>
                        <li>‚úÖ Luxury Style</li>
                        <li>‚úÖ Prioritas Support</li>
                    </ul>
                    <button class="p-btn btn-pro" onclick="toBuyForm()">Langganan</button>
                </div>
            </div>
        </div>

        <div id="step-form" style="display:none;">
             <div class="ai-title">
                <span>üìù Data Pelanggan</span>
                <span onclick="backToPricing()" style="cursor:pointer; font-size:0.9rem; color:#666;"><i class="fas fa-arrow-left"></i></span>
            </div>
            <p style="font-size:0.8rem; color:#666; margin-bottom:15px;">Silakan isi data untuk melanjutkan pembayaran.</p>
            <div class="form-group">
                <label>Nama Lengkap</label>
                <input type="text" id="buyName" placeholder="Nama Anda" style="border:1px solid #ccc;">
            </div>
            <div class="form-group">
                <label>Nomor WhatsApp</label>
                <input type="tel" id="buyWA" placeholder="08xxx" style="border:1px solid #ccc;">
            </div>
            <button class="btn-action" style="background:#25D366;" onclick="processOrder()">BELI SEKARANG</button>
        </div>

    </div>
</div>

<div id="paymentModal">
    <div class="ai-content">
        <div class="ai-title" style="color:#166534"><span>‚úÖ Order Diterima!</span></div>
        <p style="font-size:0.9rem; text-align:center; margin-bottom:10px;">Silakan transfer pembayaran ke:</p>
        
        <div class="pay-box">
            <span style="font-size:0.8rem; font-weight:600; color:#166534">BANK BCA</span>
            <span class="pay-rek" id="rekNum">0040112928</span>
            <span style="font-size:0.8rem; color:#166534">An. HERMAN KOSASI</span>
            <br><button class="copy-btn" onclick="copyRek()">Salin No. Rek</button>
        </div>
        
        <div id="paymentInfo" style="font-size:0.8rem; text-align:center; color:#666; margin-bottom:15px;">
            Kode unik telah dibuat. Konfirmasi via WA untuk aktivasi.
        </div>
        
        <button class="btn-action" style="background:#25D366;" onclick="confirmWA()"><i class="fab fa-whatsapp"></i> KONFIRMASI PEMBAYARAN</button>
        <button class="btn-reset" style="width:100%; background:none; color:#999; margin-top:10px; font-size:0.8rem;" onclick="closeModal('paymentModal')">Tutup</button>
    </div>
</div>

<div id="userProfileModal" onclick="closeModal('userProfileModal')">
    <div class="ai-content" onclick="event.stopPropagation()">
        <div class="ai-title">
            <span>üë§ Profil Pengguna</span>
            <span onclick="closeModal('userProfileModal')" style="cursor:pointer;">&times;</span>
        </div>
        
        <div class="user-card-info">
            <div class="uc-avatar"><i class="fas fa-user"></i></div>
            <div class="uc-name" id="profileName">-</div>
            <div class="uc-status">PRO MEMBER</div>
            <div class="uc-exp" id="profileExp">Berlaku sampai: -</div>
        </div>
        
        <div style="font-size:0.75rem; color:#666; margin-bottom:10px;">
            <i class="fas fa-info-circle"></i> Simpan Kode Lisensi Anda baik-baik. Jika history browser terhapus, Anda perlu memasukkannya lagi.
        </div>
        
        <button class="btn-logout" onclick="logout()">LOGOUT / GANTI AKUN</button>
    </div>
</div>

<div class="mobile-frame">
    <div class="header">
        <div class="header-left">
            <h1>Agent<span>Pro</span> <span style="font-size:0.6rem; color:#999;">v23.0</span></h1>
            <div class="user-greet" id="userGreet" onclick="openUserProfile()" style="display:none;">
                <i class="fas fa-user-circle"></i> <span id="headerUserName">User</span>
            </div>
        </div>
        <div class="btn-group-head">
            <button class="btn-buy-pro" id="btnBuy" onclick="openBuyModal()"><i class="fas fa-crown"></i> BELI PRO</button>
            <button class="btn-reset btn-lic" id="btnLicense" onclick="checkLicense()" title="Masukan Lisensi"><i class="fas fa-key"></i></button>
            <button class="btn-reset" onclick="openProjectModal()"><i class="fas fa-folder-open"></i></button>
            <button class="btn-reset" onclick="resetForm()" title="Reset / Baru"><i class="fas fa-file-alt"></i></button>
        </div>
    </div>
    <div id="toast" class="toast"><i class="fas fa-check-circle" style="color:var(--primary)"></i> Tersimpan</div>

    <div class="content">
        
        <div id="tab-edit" class="section active">
             <div class="card">
                <div class="card-head"><i class="fas fa-paint-brush"></i> Branding & Status</div>
                <div class="cap-tools">
                    <div class="cap-opt">
                        <label>Tema Warna</label>
                        <select id="themeColor" onchange="applyTheme()">
                            <option value="yellow">üü° Kuning</option>
                            <option value="red">üî¥ Merah (ERA)</option>
                            <option value="blue">üîµ Biru (Remax)</option>
                            <option value="green">üü¢ Hijau (Promex)</option>
                            <option value="gold">üèÜ Gold (Century)</option>
                        </select>
                    </div>
                    <div class="cap-opt">
                        <label>Stempel Status</label>
                        <select id="statusBadge" onchange="renderAll()">
                            <option value="">- Kosong -</option>
                            <option value="TERJUAL">‚úÖ TERJUAL</option>
                            <option value="TERSEWA">üîë TERSEWA</option>
                            <option value="BOOKED">üìù BOOKED</option>
                            <option value="TURUN HARGA">üîª TURUN HARGA</option>
                        </select>
                    </div>
                </div>
             </div>

            <div class="card">
                <div class="card-head"><i class="fas fa-images"></i> Foto Properti</div>
                <button class="btn-action btn-bulk" onclick="document.getElementById('multiFileInput').click()">
                    <i class="fas fa-folder-plus"></i> Upload Banyak Foto Sekaligus
                </button>
                <input type="file" id="multiFileInput" hidden multiple accept="image/*" onchange="handleMultiFileSelect(event)">
                
                <div class="upload-grid">
                    <div class="upload-box" id="box-0" onclick="triggerUpload(0)">
                        <div class="placeholder"><i class="fas fa-plus"></i>Foto Utama</div>
                        <img id="prev-0">
                        <div class="del-btn" onclick="removeImg(0, event)">√ó</div>
                    </div>
                    <div class="upload-box" id="box-1" onclick="triggerUpload(1)">
                        <div class="placeholder"><i class="fas fa-plus"></i>Foto 2</div>
                        <img id="prev-1">
                        <div class="del-btn" onclick="removeImg(1, event)">√ó</div>
                    </div>
                    <div class="upload-box" id="box-2" onclick="triggerUpload(2)">
                        <div class="placeholder"><i class="fas fa-plus"></i>Foto 3</div>
                        <img id="prev-2">
                        <div class="del-btn" onclick="removeImg(2, event)">√ó</div>
                    </div>
                    <div class="upload-box" id="box-3" onclick="triggerUpload(3)">
                        <div class="placeholder"><i class="fas fa-plus"></i>Foto 4</div>
                        <img id="prev-3">
                        <div class="del-btn" onclick="removeImg(3, event)">√ó</div>
                    </div>
                </div>
                <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFileSelect(event)">
                
                <div style="padding:0 15px 15px 15px;">
                    <div style="display:flex; gap:15px; border-top:1px dashed #eee;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; color:#333;">
                            <input type="checkbox" id="checkWatermark" checked onclick="handleWatermarkToggle(event)" style="width:auto;"> 
                            üõ°Ô∏è Watermark (Tengah)
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; color:#333;"><input type="checkbox" id="checkQR" checked onchange="renderAll()" style="width:auto;"> QR Code</label>
                    </div>
                    <div class="form-group input-group-locked" style="margin-top:10px;">
                        <label>Teks Watermark</label>
                        <input type="text" id="wmCustomText" placeholder="AGENTPRO (Default)" oninput="renderAll()" onfocus="checkProFeature(this)">
                        <i class="fas fa-lock lock-icon" id="lockWm"></i>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-head"><i class="fas fa-home"></i> Detail Properti</div>
                <div class="form-group">
                    <label>Jenis Properti</label>
                    <select id="tipeProp" onchange="renderAll()">
                        <option value="RUMAH">RUMAH</option>
                        <option value="RUKO">RUKO</option>
                        <option value="TANAH">TANAH</option>
                        <option value="APARTEMEN">APARTEMEN</option>
                        <option value="GUDANG">GUDANG</option>
                        <option value="KANTOR">KANTOR</option>
                        <option value="VILLA">VILLA</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Status</label>
                    <select id="status" onchange="handleStatusChange()">
                        <option value="DIJUAL">DIJUAL (Hanya Jual)</option>
                        <option value="DISEWA">DISEWA (Hanya Sewa)</option>
                        <option value="JUAL/SEWA">JUAL & SEWA (Dua Harga)</option>
                    </select>
                </div>

                <div class="row form-group" id="priceContainer">
                    <div class="col" id="colJual">
                        <label>Harga Jual (M/Jt)</label>
                        <input type="text" id="hargaJual" oninput="renderAll()" style="font-weight:700;" placeholder="Rp ...">
                    </div>
                    <div class="col hidden-input" id="colSewa">
                        <label>Harga Sewa (Jt/Thn)</label>
                        <input type="text" id="hargaSewa" oninput="renderAll()" style="font-weight:700;" placeholder="Rp ...">
                    </div>
                </div>

                <div class="form-group"><label style="color:#ef4444;">Harga Coret (Hanya utk Jual)</label><input type="text" id="hargaCoret" placeholder="Opsional" oninput="renderAll()" style="background:#fef2f2; color:#ef4444;"></div>
                
                <div class="form-group">
                    <label>Judul Headline</label>
                    <input type="text" id="judul" oninput="renderAll()" placeholder="Contoh: RUMAH MEWAH DI PIK">
                    <button class="btn-ai-gen" onclick="openAIHeadlines()"><i class="fas fa-magic"></i> Buat Judul Otomatis (AI) <span style="background:#000; color:gold; padding:0 4px; border-radius:3px; font-size:0.6rem; margin-left:5px;">PRO</span></button>
                </div>

                <div class="form-group"><label>Lokasi</label><input type="text" id="lokasi" oninput="renderAll()" placeholder="Contoh: Jakarta Barat"></div>
            </div>

            <div class="card">
                <div class="card-head"><i class="fas fa-sliders-h"></i> Spesifikasi</div>
                <div class="row form-group">
                    <div class="col"><label>LT (m¬≤)</label><input type="number" id="lt" oninput="renderAll()"></div>
                    <div class="col"><label>LB (m¬≤)</label><input type="number" id="lb" oninput="renderAll()"></div>
                    <div class="col"><label>KT</label><input type="number" id="kt" oninput="renderAll()"></div>
                    <div class="col"><label>KM</label><input type="number" id="km" oninput="renderAll()"></div>
                </div>
                <div class="row form-group">
                    <div class="col">
                        <label>Legal</label>
                        <select id="legal" onchange="renderAll()">
                            <option value="">- (Kosong) -</option>
                            <option value="SHM">SHM</option>
                            <option value="HGB">HGB</option>
                            <option value="AJB">AJB</option>
                            <option value="PPJB">PPJB</option>
                        </select>
                    </div>
                    <div class="col"><label>Watt</label><input type="text" id="listrik" oninput="renderAll()"></div>
                </div>
                <div class="row form-group">
                    <div class="col">
                        <label>Hadap</label>
                        <select id="hadap" onchange="renderAll()">
                            <option value="">- (Kosong) -</option>
                            <option>Utara</option><option>Selatan</option><option>Timur</option><option>Barat</option><option>Utr-Tmr</option><option>Utr-Brt</option><option>Slt-Tmr</option><option>Slt-Brt</option>
                        </select>
                    </div>
                    <div class="col"><label>Air</label><input type="text" id="air" oninput="renderAll()"></div>
                </div>
                
                <div class="row form-group">
                    <div class="col">
                        <label>Furnish</label>
                        <select id="furnish" onchange="renderAll()">
                            <option value="">- (Kosong) -</option>
                            <option value="Semi">Semi</option><option value="Full">Full</option><option value="Kosong">Kosong</option>
                        </select>
                    </div>
                    <div class="col"><label>Garasi/Carport</label><input type="number" id="garasi" oninput="renderAll()"></div>
                </div>
                 <div class="form-group input-group-locked">
                     <label>Poin Plus / Deskripsi</label>
                     <textarea id="poin" rows="2" placeholder="Detail Properti (Terkunci di Versi Free)..." onclick="checkProFeature(this)"></textarea>
                     <i class="fas fa-lock lock-icon" id="lockPoin"></i>
                 </div>
            </div>
            
            <div class="card">
                <div class="card-head"><i class="fas fa-calculator"></i> Kalkulator KPR Manual</div>
                <div class="kpr-input-grid">
                     <div class="kpr-box"><label>DP (%)</label><input type="number" id="kprDP" value="20" oninput="generateCaption()"></div>
                     <div class="kpr-box"><label>Bunga (%)</label><input type="number" id="kprBunga" value="5" oninput="generateCaption()"></div>
                     <div class="kpr-box"><label>Tenor (Thn)</label><input type="number" id="kprTenor" value="15" oninput="generateCaption()"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-head"><i class="fas fa-user-circle"></i> Profil Agen</div>
                <div class="row">
                     <div class="col" style="flex:0.3">
                         <div style="width:100%; aspect-ratio:1; background:#f3f4f6; border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px dashed #ccc; overflow:hidden;" onclick="document.getElementById('fileAg').click()">
                            <img id="agEditPreview" class="img-cover" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E">
                         </div>
                         <input type="file" id="fileAg" hidden accept="image/*" onchange="loadAgentImg(event)">
                     </div>
                     <div class="col">
                         <div class="form-group" style="margin-bottom:8px;"><label>Nama</label><input type="text" id="nama" oninput="renderAll()"></div>
                         <div class="form-group" style="margin-bottom:0;"><label>WhatsApp</label><input type="tel" id="hp" oninput="renderAll()"></div>
                     </div>
                </div>
                <div class="form-group" style="margin-top:10px;"><label>Nama Kantor</label><input type="text" id="kantor" oninput="renderAll()"></div>
                
                <div class="form-group" style="margin-top:10px; border-top:1px dashed #eee; padding-top:10px;">
                    <label>Logo Kantor / Agency (PNG Transparan) <span id="proBadgeLogo" style="background:#000; color:gold; padding:2px 4px; border-radius:3px; font-size:0.6rem; margin-left:5px;">PRO ONLY</span></label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div style="width:60px; height:40px; background:#eee; display:flex; align-items:center; justify-content:center; border-radius:4px; overflow:hidden; border:1px solid #ddd;">
                             <img id="logoPreview" style="max-width:100%; max-height:100%; display:none;">
                             <span id="logoPlaceholder" style="font-size:0.5rem; color:#999;">No Logo</span>
                        </div>
                        <button class="segment-btn" onclick="document.getElementById('fileLogo').click()" style="width:auto; background:#fff; border:1px solid #ccc;">Upload Logo</button>
                        <button class="segment-btn" onclick="clearLogo()" style="width:auto; color:red;"><i class="fas fa-times"></i></button>
                    </div>
                    <input type="file" id="fileLogo" hidden accept="image/*" onchange="handleLogoSelect(event)">
                </div>
            </div>
            
            <div class="copyright">¬© 2025 AgentPro Tools. Created by Herman Kosasi</div>
        </div>

        <div id="tab-poster" class="section">
            <div class="segment-control">
                <button class="segment-btn active" id="btnFeed" onclick="setMode('feed')">Feed (4:5)</button>
                <button class="segment-btn" id="btnStory" onclick="setMode('story')">Story (9:16)</button>
            </div>
            
            <div class="slider-box">
                <i class="fas fa-sun" style="color:var(--primary)"></i>
                <div style="flex:1; margin:0 10px;">
                     <label style="font-size:0.65rem; color:#888; margin-bottom:4px;">Kecerahan Foto (Live)</label>
                     <input type="range" style="width:100%; accent-color:var(--primary);" min="50" max="150" value="100" oninput="adjustBrightness(this.value)">
                </div>
                <span id="brightVal" style="font-size:0.7rem; font-weight:700; width:30px;">100</span>
            </div>
            
            <div class="form-group" style="background:#fff; padding:10px; border-radius:10px; margin-bottom:15px; border:1px solid #eee;">
                <label>Style Desain</label>
                <select id="posterStyle" onchange="changePosterStyle(this.value)">
                    <option value="modern">‚ö™ Modern (Clean Light)</option>
                    <option value="luxury">‚ö´ Luxury (Black & Gold) [PRO]</option>
                </select>
            </div>

            <div class="preview-container" id="previewContainer">
                <div class="poster-scaler" id="posterScaler">
                    <div id="posterCanvas" class="feed">
                        
                        <div class="canvas-img-area layout-1" id="imgGrid">
                            
                            <div class="price-badge-container" id="dynamicPriceBox">
                                </div>

                            <div id="stampDisplay" class="status-badge">TERJUAL</div>
                            <div class="watermark" id="watermarkLayer"><span id="wmTextDisplay">AGENTPRO</span></div>
                        </div>

                        <div class="canvas-info-area">
                            <div>
                                <div class="prop-indicator" id="o_tipe_display">RUMAH</div>
                                <div class="info-title" id="o_judul">JUDUL PROPERTY</div>
                                <div class="info-loc"><i class="fas fa-map-marker-alt" style="color:var(--primary)"></i> <span id="o_lokasi">Lokasi</span></div>
                                
                                <div class="specs-grid">
                                    <div class="spec-box" id="box_lt"><div class="spec-val"><i class="fas fa-expand"></i> <span id="o_lt">160</span></div><div class="spec-label">LT</div></div>
                                    <div class="spec-box" id="box_lb"><div class="spec-val"><i class="fas fa-home"></i> <span id="o_lb">220</span></div><div class="spec-label">LB</div></div>
                                    <div class="spec-box" id="box_kt"><div class="spec-val"><i class="fas fa-bed"></i> <span id="o_kt">4</span></div><div class="spec-label">KT</div></div>
                                    <div class="spec-box" id="box_km"><div class="spec-val"><i class="fas fa-bath"></i> <span id="o_km">3</span></div><div class="spec-label">KM</div></div>
                                    <div class="spec-box" id="box_legal"><div class="spec-val"><i class="fas fa-file-contract"></i> <span id="o_legal">SHM</span></div><div class="spec-label">Legal</div></div>
                                    
                                    <div class="spec-box" id="box_listrik"><div class="spec-val"><i class="fas fa-bolt"></i> <span id="o_listrik">3500</span></div><div class="spec-label">Watt</div></div>
                                    <div class="spec-box" id="box_air"><div class="spec-val"><i class="fas fa-tint"></i> <span id="o_air">PAM</span></div><div class="spec-label">Air</div></div>
                                    <div class="spec-box" id="box_hadap"><div class="spec-val"><i class="fas fa-compass"></i> <span id="o_hadap">Utara</span></div><div class="spec-label">Hadap</div></div>
                                    <div class="spec-box" id="box_furnish"><div class="spec-val"><i class="fas fa-couch"></i> <span id="o_furnish">Semi</span></div><div class="spec-label">Furnish</div></div>
                                    <div class="spec-box" id="box_garasi"><div class="spec-val"><i class="fas fa-car"></i> <span id="o_garasi">2</span></div><div class="spec-label">Carport</div></div>
                                </div>
                            </div>

                            <div class="agent-bar">
                                <div class="agent-profile">
                                    <div class="agent-pic-box">
                                        <img id="agDisplay" class="img-cover" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E">
                                    </div>
                                    <div class="agent-text">
                                        <h4 id="o_nama">NAMA AGEN</h4>
                                        <p id="o_kontak">Nama Kantor</p>
                                        <span id="o_hp_display" class="agent-phone"><i class="fab fa-whatsapp"></i> 0812...</span>
                                    </div>
                                </div>
                                
                                <div id="logoCanvasWrapper" style="display:none; height:35px; max-width:80px; margin-right:8px; align-items:center;">
                                    <img id="logoImgDisplay" src="" style="max-height:100%; max-width:100%; object-fit:contain;">
                                </div>

                                <div class="qr-wrapper" id="qrBox"><img id="qrImage" src="" alt="QR"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
            <div style="display:flex; gap:10px;">
                <button class="btn-action" onclick="downloadPoster()" style="flex:1"><i class="fas fa-download"></i> Simpan HD</button>
                <button class="btn-action btn-share" onclick="sharePoster()"><i class="fas fa-share-alt"></i> Share</button>
            </div>
            <div class="copyright">¬© 2025 AgentPro Tools. Created by Herman Kosasi</div>
        </div>

        <div id="tab-reels" class="section">
            <div class="reels-container">
                 <div class="reels-icon"><i class="fas fa-video"></i></div>
                 <h3 style="margin:0 0 10px 0;">Buat Video Reels</h3>
                 <p class="reels-desc">Video slideshow 9:16 dengan Overlay Judul, Harga & Detail Agent. Siap posting ke TikTok/Instagram.</p>
                 <video id="reelsPreview" controls playsinline></video>
                 <button class="btn-action" style="background:#E1306C;" onclick="generateReels()"><i class="fas fa-play-circle"></i> Mulai Render Video</button>
            </div>
             <div class="copyright">¬© 2025 AgentPro Tools. Created by Herman Kosasi</div>
        </div>

        <div id="tab-caption" class="section">
            <div class="card">
                <div class="card-head"><i class="fas fa-robot"></i> Smart Generator</div>
                <div class="cap-tools">
                    <div class="cap-opt">
                        <label>Gaya Bahasa</label>
                        <select id="capTone" onchange="generateCaption()">
                            <option value="formal">üëî Formal</option>
                            <option value="hype">üî• Viral/Hype</option>
                            <option value="story">üìñ Storytelling</option>
                        </select>
                    </div>
                    <div class="cap-opt">
                        <label>Platform</label>
                        <select id="capPlatform" onchange="generateCaption()">
                            <option value="ig">Instagram</option>
                            <option value="wa">WhatsApp (Bold)</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom:15px; background:#f0f9ff; padding:10px; border-radius:8px; border:1px solid #bae6fd;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; color:#0369a1; font-weight:700; font-size:0.8rem;">
                        <input type="checkbox" id="checkKPR" onchange="generateCaption()" checked style="width:auto;"> 
                        üè¶ Gunakan Hasil Hitungan KPR Manual
                    </label>
                </div>
                <button class="btn-ai-gen btn-magic" onclick="rewriteCaptionAI()"><i class="fas fa-sparkles"></i> ‚ú® Magic Rewrite (Ganti Gaya & Emoji)</button>
                
                <div class="card-head" style="margin-top:20px;"><i class="fas fa-align-left"></i> Hasil Caption</div>
                <textarea id="finalCaption" rows="18" readonly style="background:#fff; border:1px solid #eee; font-family:monospace; font-size:0.8rem;"></textarea>
                <button onclick="copyCaption()" class="btn-action" style="margin-top:15px; background:#333; font-size:0.8rem; padding:10px;"><i class="fas fa-copy"></i> Salin Teks</button>
            </div>
            <div class="copyright">¬© 2025 AgentPro Tools. Created by Herman Kosasi</div>
        </div>

    </div>

    <div class="nav-bar">
        <div class="nav-btn active" onclick="nav('edit', this)"><i class="fas fa-pen-nib"></i> Edit</div>
        <div class="nav-btn" onclick="nav('poster', this)"><i class="fas fa-image"></i> Poster</div>
        <div class="nav-btn" onclick="nav('reels', this)"><i class="fas fa-video"></i> Reels</div>
        <div class="nav-btn" onclick="nav('caption', this)"><i class="fas fa-magic"></i> Caption</div>
    </div>
</div>

<script>
    // --- KONFIGURASI PENTING ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyDO__v2wnUEF5V-0cQb4q_iEmd5U0LzymOcWgCILiwptWIzkV1-PjOzlUAKcHFp4Q/exec"; 
    // ----------------------------

    let currentMode = 'feed';
    const themes = {
        'yellow': { primary: '#FFD900', text: '#000000' },
        'red': { primary: '#dc2626', text: '#ffffff' },
        'blue': { primary: '#2563eb', text: '#ffffff' },
        'green': { primary: '#16a34a', text: '#ffffff' },
        'gold': { primary: '#d4af37', text: '#ffffff' }
    };
    
    // SAFE DEFAULT IMAGE (Base64)
    let propImages = [null, null, null, null]; 
    let defaultImg = "data:image/svg+xml,%3Csvg width='600' height='400' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100%25' height='100%25' fill='%23eee'/%3E%3Ctext x='50%25' y='50%25' font-family='sans-serif' font-size='24' fill='%23aaa' dominant-baseline='middle' text-anchor='middle'%3EPreview Foto%3C/text%3E%3C/svg%3E";
    
    let activeUploadSlot = 0;
    let globalBrightness = 100;
    let qrDebounceTimer;
    let officeLogoData = null;
    
    let userLicenseStatus = "FREE";
    let tempBuyName = "";
    let tempCode = "";

    window.onload = function() { 
        loadProfile(); 
        handleStatusChange(); 
        autoScale(); 
        setTimeout(fitAllImages, 500); 
        
        const lic = localStorage.getItem('agentPro_license');
        if(lic) {
            try {
                const user = JSON.parse(lic);
                userLicenseStatus = "PRO";
                updateUIForPro(user);
            } catch(e) {
                console.log("Lisensi invalid");
            }
        } else {
            document.querySelectorAll('.input-group-locked').forEach(el => el.classList.add('pro-locked'));
        }
    };
    window.onresize = () => { autoScale(); fitAllImages(); };

    // --- MODAL SYSTEM ---
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }
    
    function openBuyModal() {
        document.getElementById('buyModal').style.display = 'flex';
        // RESET TO STEP 1
        document.getElementById('step-pricing').style.display = 'block';
        document.getElementById('step-form').style.display = 'none';
    }
    
    function toBuyForm() {
        document.getElementById('step-pricing').style.display = 'none';
        document.getElementById('step-form').style.display = 'block';
    }

    function backToPricing() {
        document.getElementById('step-pricing').style.display = 'block';
        document.getElementById('step-form').style.display = 'none';
    }
    
    function openUserProfile() {
        document.getElementById('userProfileModal').style.display = 'flex';
        // Load data from local
        const lic = localStorage.getItem('agentPro_license');
        if(lic) {
            const user = JSON.parse(lic);
            document.getElementById('profileName').innerText = user.name || "User";
            document.getElementById('profileExp').innerText = "Berlaku sampai: " + (user.expired || "-");
        }
    }

    // --- BUY LOGIC ---
    function processOrder() {
        const name = document.getElementById('buyName').value;
        const wa = document.getElementById('buyWA').value;
        if(!name || !wa) return alert("Mohon isi Nama dan WhatsApp!");
        
        tempBuyName = name;
        document.getElementById('loadingOverlay').style.display = 'flex';

        fetch(SCRIPT_URL + "?action=register&nama=" + encodeURIComponent(name) + "&hp=" + encodeURIComponent(wa))
        .then(res => res.json())
        .then(data => {
            document.getElementById('loadingOverlay').style.display = 'none';
            if(data.status === "BERHASIL") {
                tempCode = data.code; 
                closeModal('buyModal');
                
                const infoText = data.info === "EXISTING" ? 
                    "Anda memiliki pesanan yang belum dibayar. Gunakan kode ini:" : 
                    "Kode unik telah dibuat. Konfirmasi via WA untuk aktivasi.";
                
                document.getElementById('paymentInfo').innerText = infoText;
                document.getElementById('paymentModal').style.display = 'flex';
            } else {
                alert("Gagal membuat order: " + data.pesan);
            }
        })
        .catch(err => {
            document.getElementById('loadingOverlay').style.display = 'none';
            alert("Gagal koneksi. Coba lagi.");
        });
    }

    function confirmWA() {
        const msg = `Halo Admin, saya sudah transfer ke BCA 0040112928 untuk lisensi AgentPro.\n\nNama: ${tempBuyName}\nKode Order: ${tempCode}\n\nMohon diaktifkan.`;
        window.open(`https://wa.me/6285760035568?text=${encodeURIComponent(msg)}`, '_blank');
    }
    
    function copyRek() {
        navigator.clipboard.writeText("0040112928").then(() => alert("No Rekening Disalin!"));
    }

    // --- LICENSE CHECK ---
    function checkLicense() {
        if(userLicenseStatus === 'PRO') {
            openUserProfile(); // Show profile if already logged in
            return;
        }
        
        const code = prompt("Masukkan Kode Lisensi:");
        if(!code) return;

        document.getElementById('loadingOverlay').style.display = 'flex';
        
        fetch(SCRIPT_URL + "?action=check&kode=" + code)
        .then(res => res.json())
        .then(data => {
            document.getElementById('loadingOverlay').style.display = 'none';
            if(data.status === "SUKSES") {
                userLicenseStatus = "PRO";
                const userData = { name: data.nama, expired: data.expired, code: code };
                localStorage.setItem('agentPro_license', JSON.stringify(userData));
                
                alert("‚úÖ Selamat datang " + data.nama + "! Fitur PRO Aktif.");
                updateUIForPro(userData);
            } else {
                alert("‚ùå " + data.pesan);
            }
        })
        .catch(err => {
            document.getElementById('loadingOverlay').style.display = 'none';
            alert("Gagal koneksi server.");
        });
    }
    
    function logout() {
        if(confirm("Yakin ingin keluar? Fitur PRO akan terkunci kembali.")) {
            localStorage.removeItem('agentPro_license');
            location.reload();
        }
    }

    function updateUIForPro(userData) {
        document.getElementById('btnLicense').style.display = 'none'; 
        document.getElementById('btnBuy').style.display = 'none';
        
        const greet = document.getElementById('userGreet');
        greet.style.display = 'flex';
        document.getElementById('headerUserName').innerText = userData.name || "User";
        
        document.getElementById('proBadgeLogo').style.display = 'none'; 
        
        document.getElementById('wmCustomText').readOnly = false;
        document.getElementById('poin').readOnly = false;
        document.getElementById('poin').placeholder = "Contoh: Bebas banjir, dekat tol...";
        
        document.getElementById('lockWm').style.display = 'none';
        document.getElementById('lockPoin').style.display = 'none';
        
        document.querySelectorAll('.input-group-locked').forEach(el => el.classList.remove('pro-locked'));

        document.getElementById('toast').innerHTML = '<i class="fas fa-check"></i> Mode PRO Aktif';
        document.getElementById('toast').classList.add('show');
        setTimeout(() => document.getElementById('toast').classList.remove('show'), 2000);
    }
    
    function applyTheme() {
        const themeKey = document.getElementById('themeColor').value;
        const theme = themes[themeKey];
        document.documentElement.style.setProperty('--primary', theme.primary);
        document.documentElement.style.setProperty('--text-on-primary', theme.text);
    }
    
    // --- LOCK HELPERS ---
    function handleWatermarkToggle(e) {
        if(userLicenseStatus !== 'PRO') {
            e.preventDefault(); 
            alert("üîí UPGRADE KE PRO!\n\nAgen Gratis wajib menampilkan Watermark.\nSilakan masukkan lisensi untuk menghapusnya.");
        } else {
            renderAll(); 
        }
    }

    function checkProFeature(el) {
        if(userLicenseStatus !== 'PRO') {
            el.blur(); 
            alert("üîí FITUR TERKUNCI!\n\nFitur ini khusus member PRO.\nSilakan masukkan kode lisensi.");
        }
    }

    function changePosterStyle(style) {
        if(style === 'luxury' && userLicenseStatus !== 'PRO') {
            alert("üîí GAYA LUXURY TERKUNCI!\n\nFitur ini khusus member PRO.");
            document.getElementById('posterStyle').value = 'modern';
            return;
        }

        const canvas = document.getElementById('posterCanvas');
        if(style === 'luxury') {
            canvas.classList.add('luxury-theme');
        } else {
            canvas.classList.remove('luxury-theme');
        }
    }

    function openAIHeadlines() {
        if(userLicenseStatus !== 'PRO') {
            alert("üîí AI HEADLINE TERKUNCI!\n\nUpgrade ke PRO untuk membuat judul otomatis.");
            return;
        }
        
        const val = (id) => document.getElementById(id).value;
        const tipe = val('tipeProp').toUpperCase();
        const loc = val('lokasi').toUpperCase().split(',')[0];
        const harga = val('hargaJual');
        const specs = `${val('lt')}m¬≤`;
        
        const templates = [
            `DIJUAL CEPAT! ${tipe} DI ${loc} HANYA ${harga}`,
            `${tipe} MEWAH SIAP HUNI DI ${loc}, LT ${specs}`,
            `INVESTASI TERBAIK! ${tipe} STRATEGIS DI JANTUNG ${loc}`,
            `TERMURAH DI KELASNYA! ${tipe} ${loc} JARANG ADA`,
            `BUC! ${tipe} ${loc} HARGA MIRING ${harga} NEGO`,
            `${tipe} CANTIK TERAWAT DI ${loc}, LINGKUNGAN ASRI`,
            `HITUNG TANAH SAJA! ${tipe} ${loc} POSISI HOOK`,
            `LANGKA! ${tipe} ${loc} HARGA NEGO SAMPAI JADI`,
            `DEKAT AKSES TOL! ${tipe} ${loc} BEBAS BANJIR`,
            `${tipe} MODERN MINIMALIS DI ${loc} SIAP HUNI`,
            `TURUN HARGA! ${tipe} ${loc} DARI PEMILIK LANGSUNG`,
            `${tipe} BARU GRESS DI ${loc} - ${harga} SAJA!`,
            `HOT DEAL! ${tipe} ${loc} LOKASI PREMIUM`,
            `JUAL BUTUH! ${tipe} ${loc} DIBAWAH PASAR`,
            `${tipe} 2 LANTAI DI ${loc}, DESIGN MEWAH`
        ];

        for (let i = templates.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [templates[i], templates[j]] = [templates[j], templates[i]];
        }
        
        const list = document.getElementById('aiList');
        list.innerHTML = ''; 
        
        templates.slice(0, 3).forEach(opt => {
            const div = document.createElement('div');
            div.className = 'ai-option';
            div.innerText = opt;
            div.onclick = () => selectAIHeadline(opt);
            list.appendChild(div);
        });
        document.getElementById('aiModal').style.display = 'flex';
    }

    function selectAIHeadline(text) {
        document.getElementById('judul').value = text;
        renderAll();
        closeModal('aiModal');
    }

    // --- UPLOAD & RENDER ---
    function triggerUpload(idx) {
        activeUploadSlot = idx;
        document.getElementById('fileInput').click();
    }
    
    // --- MULTI UPLOAD ---
    function handleMultiFileSelect(event) {
        const files = event.target.files;
        if (!files.length) return;
        
        // Batasi Max 4
        const total = Math.min(files.length, 4);
        let loaded = 0;
        
        for (let i = 0; i < total; i++) {
            if (files[i].size > 5 * 1024 * 1024) { alert("File ke-" + (i+1) + " terlalu besar!"); continue; }
            
            const r = new FileReader();
            r.onload = (ev) => {
                propImages[i] = ev.target.result;
                loaded++;
                if (loaded === total) {
                      updateThumbnails();
                      renderImages();
                }
            };
            r.readAsDataURL(files[i]);
        }
        event.target.value = ''; // Reset
    }

    function handleFileSelect(event) {
        const f = event.target.files[0];
        if(f) {
            // Check size max 5MB
            if (f.size > 5 * 1024 * 1024) {
                alert("File terlalu besar! Max 5MB.");
                return;
            }
            const r = new FileReader();
            r.onload = (ev) => {
                propImages[activeUploadSlot] = ev.target.result;
                updateThumbnails();
                renderImages();
            };
            r.readAsDataURL(f);
        }
        document.getElementById('fileInput').value = ''; 
    }

    function removeImg(idx, e) {
        e.stopPropagation();
        propImages[idx] = null;
        updateThumbnails();
        renderImages();
    }

    function updateThumbnails() {
        for(let i=0; i<4; i++) {
            const box = document.getElementById('box-'+i);
            const img = document.getElementById('prev-'+i);
            if(propImages[i]) {
                box.classList.add('has-img');
                img.src = propImages[i];
            } else {
                box.classList.remove('has-img');
                img.src = '';
            }
        }
    }

    function renderImages() {
        const c = document.getElementById('imgGrid');
        
        // Simpan elemen overlay
        const priceBadge = document.getElementById('dynamicPriceBox');
        const stamp = document.getElementById('stampDisplay');
        const wm = document.getElementById('watermarkLayer');
        
        c.innerHTML = ''; 
        
        const active = propImages.filter(i => i);
        let count = active.length;
        if(count === 0) { count = 1; active.push(defaultImg); }
        
        c.className = `canvas-img-area layout-${count}`;
        active.forEach((src, i) => {
            const div = document.createElement('div');
            div.className = 'grid-item';
            div.innerHTML = `<img id="gridImg-${i}" src="${src}" crossorigin="anonymous" onload="manualFitSingle('gridImg-${i}')" style="filter: brightness(${globalBrightness}%)">`;
            c.appendChild(div);
        });
        
        if(priceBadge) c.appendChild(priceBadge);
        if(stamp) c.appendChild(stamp);
        if(wm) c.appendChild(wm);
        
        setTimeout(fitAllImages, 100);
    }

    function manualFitSingle(id) {
        const img = document.getElementById(id);
        if(!img) return;
        const container = img.parentElement;
        const cRatio = container.offsetWidth / container.offsetHeight;
        const iRatio = img.naturalWidth / img.naturalHeight;
        if (iRatio > cRatio) { img.style.width = 'auto'; img.style.height = '100%'; } 
        else { img.style.width = '100%'; img.style.height = 'auto'; }
    }

    function fitAllImages() {
        const imgs = document.querySelectorAll('.grid-item img');
        imgs.forEach(img => manualFitSingle(img.id));
    }

    function handleStatusChange() {
        const s = document.getElementById('status').value;
        document.getElementById('colJual').className = (s === 'DISEWA') ? 'col hidden-input' : 'col';
        document.getElementById('colSewa').className = (s === 'DIJUAL') ? 'col hidden-input' : 'col';
        renderAll();
    }

    function handleLogoSelect(event) {
        if(userLicenseStatus !== 'PRO') {
            alert("üîí UPLOAD LOGO TERKUNCI!\n\nFitur ini khusus member PRO.");
            document.getElementById('fileLogo').value = ''; 
            return;
        }

        const f = event.target.files[0];
        if(f) {
            const r = new FileReader();
            r.onload = (ev) => {
                officeLogoData = ev.target.result;
                updateLogoUI();
            };
            r.readAsDataURL(f);
        }
    }

    function clearLogo() {
        officeLogoData = null;
        document.getElementById('fileLogo').value = '';
        updateLogoUI();
    }

    function updateLogoUI() {
        const prev = document.getElementById('logoPreview');
        const plac = document.getElementById('logoPlaceholder');
        if(officeLogoData) {
            prev.src = officeLogoData; prev.style.display = 'block'; plac.style.display = 'none';
        } else {
            prev.style.display = 'none'; plac.style.display = 'block';
        }

        const cvsWrap = document.getElementById('logoCanvasWrapper');
        const cvsImg = document.getElementById('logoImgDisplay');
        
        if(officeLogoData) {
            cvsWrap.style.display = 'flex';
            cvsImg.src = officeLogoData;
        } else {
            cvsWrap.style.display = 'none';
        }
    }

    function renderAll() {
        const val = (id) => document.getElementById(id).value;
        const status = document.getElementById('status').value;

        if(val('nama') && val('hp')) {
            localStorage.setItem('agentPro_text', JSON.stringify({ nama: val('nama'), hp: val('hp'), kantor: val('kantor'), wm: val('wmCustomText'), theme: val('themeColor') }));
        }

        const mapText = (src, dest) => { 
            const el = document.getElementById(dest);
            if(el) el.innerText = val(src); 
        };
        
        const pJual = val('hargaJual');
        const pSewa = val('hargaSewa');
        const priceBox = document.getElementById('dynamicPriceBox');
        const oldPrice = val('hargaCoret');
        
        let htmlPrice = '';
        let strikeHTML = '';
        if(status !== 'DISEWA' && oldPrice && oldPrice.trim() !== "") {
            strikeHTML = `<div class="price-strike">${oldPrice}</div>`;
        }

        const pill = (label, val, type) => `
            <div class="price-row">
                <div class="pr-label ${type}">${label}</div>
                <div class="pr-val">${val}</div>
            </div>
        `;

        if(status === 'DIJUAL') {
            if(strikeHTML) htmlPrice += strikeHTML;
            htmlPrice += pill('DIJUAL', pJual, 'jual');
        } else if (status === 'DISEWA') {
            htmlPrice += pill('DISEWA', pSewa, 'sewa');
        } else {
            if(strikeHTML) htmlPrice += strikeHTML;
            htmlPrice += pill('DIJUAL', pJual, 'jual');
            htmlPrice += pill('DISEWA', pSewa, 'sewa');
        }
        priceBox.innerHTML = htmlPrice;

        mapText('judul', 'o_judul'); mapText('lokasi', 'o_lokasi');
        
        const updateSpec = (srcId, destId, boxId) => {
            const valInput = val(srcId);
            const box = document.getElementById(boxId);
            const txt = document.getElementById(destId);

            if(!valInput || valInput.trim() === "" || valInput === "-") {
                box.style.display = 'none';
            } else {
                box.style.display = 'block';
                txt.innerText = valInput;
            }
        };

        updateSpec('lt', 'o_lt', 'box_lt');
        updateSpec('lb', 'o_lb', 'box_lb');
        updateSpec('kt', 'o_kt', 'box_kt');
        updateSpec('km', 'o_km', 'box_km');
        updateSpec('legal', 'o_legal', 'box_legal');
        updateSpec('listrik', 'o_listrik', 'box_listrik');
        updateSpec('air', 'o_air', 'box_air');
        updateSpec('hadap', 'o_hadap', 'box_hadap');
        updateSpec('furnish', 'o_furnish', 'box_furnish');
        updateSpec('garasi', 'o_garasi', 'box_garasi');
        
        document.getElementById('o_tipe_display').innerText = val('tipeProp');
        document.getElementById('o_nama').innerText = val('nama');
        document.getElementById('o_kontak').innerText = val('kantor');
        document.getElementById('o_hp_display').innerHTML = '<i class="fab fa-whatsapp"></i> ' + val('hp');

        const badgeTxt = val('statusBadge');
        const badgeEl = document.getElementById('stampDisplay');
        if(badgeEl) {
            if(badgeTxt) {
                badgeEl.style.display = 'block';
                badgeEl.innerText = badgeTxt;
                if(badgeTxt === 'TERSEWA' || badgeTxt === 'TERJUAL') badgeEl.style.background = 'rgba(220, 38, 38, 0.9)'; 
                else if(badgeTxt === 'BOOKED') badgeEl.style.background = 'rgba(234, 88, 12, 0.9)'; 
                else badgeEl.style.background = 'rgba(22, 163, 74, 0.9)';
            } else {
                badgeEl.style.display = 'none';
            }
        }

        const wmEl = document.getElementById('watermarkLayer');
        if(wmEl) {
            const isChecked = document.getElementById('checkWatermark').checked;
            wmEl.style.display = isChecked ? 'flex' : 'none';
        } 
        const wmText = document.getElementById('wmTextDisplay');
        const customText = val('wmCustomText');
        if(wmText) wmText.innerText = customText ? customText : "AGENTPRO";

        generateQR(); // Debounced
        generateCaption();
    }

    // --- PROJECT MANAGER ---
    function openProjectModal() {
        document.getElementById('projectModal').style.display = 'flex';
        renderProjectList();
        const currentTitle = document.getElementById('judul').value;
        if(currentTitle) document.getElementById('saveName').value = currentTitle.substring(0, 20);
    }

    function saveCurrentProject() {
        const name = document.getElementById('saveName').value;
        if(!name) return alert("Isi nama listing dulu!");

        const inputs = document.querySelectorAll('input, select, textarea');
        let data = {};
        inputs.forEach(el => {
            if(el.id && el.type !== 'file') {
                if(el.type === 'checkbox') data[el.id] = el.checked;
                else data[el.id] = el.value;
            }
        });

        const projectData = {
            id: Date.now(),
            name: name,
            date: new Date().toLocaleString(),
            formData: data,
            images: propImages,
            agentImg: localStorage.getItem('agentPro_img'),
            logoImg: officeLogoData,
            posterStyle: document.getElementById('posterStyle').value 
        };

        try {
            let projects = JSON.parse(localStorage.getItem('agentPro_projects') || "[]");
            projects.push(projectData);
            localStorage.setItem('agentPro_projects', JSON.stringify(projects));
            alert("Listing berhasil disimpan!");
            renderProjectList();
        } catch (e) {
            alert("Gagal menyimpan! Memori Browser Penuh. Hapus listing lama atau kurangi ukuran foto.");
            console.error(e);
        }
    }

    function renderProjectList() {
        const list = document.getElementById('projectList');
        const projects = JSON.parse(localStorage.getItem('agentPro_projects') || "[]");
        
        if(projects.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">Belum ada listing tersimpan</div>';
            return;
        }

        projects.sort((a,b) => b.id - a.id);
        let html = '';
        projects.forEach((p, index) => {
            html += `
            <div class="proj-item" style="border-bottom:1px solid #eee; padding:10px 0; display:flex; justify-content:space-between; align-items:center;">
                <div class="proj-info">
                    <div style="font-weight:700; font-size:0.9rem;">${p.name}</div>
                    <div style="font-size:0.65rem; color:#888;">${p.date}</div>
                </div>
                <div class="proj-actions">
                    <button style="background:#dbeafe; color:#1e40af; border:none; padding:4px 8px; border-radius:5px; font-size:0.7rem; cursor:pointer;" onclick="loadProject(${p.id})">Load</button>
                    <button style="background:#fee2e2; color:#b91c1c; border:none; padding:4px 8px; border-radius:5px; font-size:0.7rem; cursor:pointer;" onclick="deleteProject(${p.id})">Hapus</button>
                </div>
            </div>`;
        });
        list.innerHTML = html;
    }

    function deleteProject(id) {
        if(!confirm("Hapus listing ini?")) return;
        let projects = JSON.parse(localStorage.getItem('agentPro_projects') || "[]");
        projects = projects.filter(p => p.id !== id);
        localStorage.setItem('agentPro_projects', JSON.stringify(projects));
        renderProjectList();
    }

    function loadProject(id) {
        const projects = JSON.parse(localStorage.getItem('agentPro_projects') || "[]");
        const p = projects.find(item => item.id === id);
        
        if(!p) return alert("Data tidak ditemukan");

        if(confirm(`Load listing "${p.name}"? Data yang belum disave akan hilang.`)) {
            const formData = p.formData;
            for (const key in formData) {
                const el = document.getElementById(key);
                if(el) {
                    if(el.type === 'checkbox') el.checked = formData[key];
                    else el.value = formData[key];
                }
            }

            propImages = p.images || [null, null, null, null];
            if(p.agentImg) {
                localStorage.setItem('agentPro_img', p.agentImg);
                document.getElementById('agEditPreview').src = p.agentImg;
                document.getElementById('agDisplay').src = p.agentImg;
            }
            
            officeLogoData = p.logoImg || null;
            updateLogoUI();
            
            if(p.posterStyle) {
                if(p.posterStyle === 'luxury' && userLicenseStatus !== 'PRO') {
                    changePosterStyle('modern');
                } else {
                    document.getElementById('posterStyle').value = p.posterStyle;
                    changePosterStyle(p.posterStyle);
                }
            }

            updateThumbnails();
            renderImages();
            handleStatusChange();
            renderAll();
            closeModal('projectModal');
            
            document.getElementById('toast').innerHTML = '<i class="fas fa-check"></i> Listing Loaded';
            document.getElementById('toast').classList.add('show');
            setTimeout(() => document.getElementById('toast').classList.remove('show'), 2000);
        }
    }

    // --- GENERATORS ---
    function generateQR() {
        const showQR = document.getElementById('checkQR').checked;
        const qrBox = document.getElementById('qrBox');
        const hp = document.getElementById('hp').value;
        const qrImg = document.getElementById('qrImage');

        if(!showQR || !hp) {
            qrBox.style.display = 'none';
            return;
        }

        qrBox.style.display = 'block';
        clearTimeout(qrDebounceTimer);
        qrDebounceTimer = setTimeout(() => {
            let cleanHP = hp.replace(/[^0-9]/g, '');
            if(cleanHP.startsWith('0')) cleanHP = '62' + cleanHP.substring(1);
            qrImg.setAttribute('crossorigin', 'anonymous'); 
            qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://wa.me/${cleanHP}`;
        }, 1000); 
    }

    function hitungDetailKPR(strHarga) {
        let dpVal = parseFloat(document.getElementById('kprDP').value) || 20; 
        let bungaVal = parseFloat(document.getElementById('kprBunga').value) || 5; 
        let tenorVal = parseFloat(document.getElementById('kprTenor').value) || 15; 

        let clean = strHarga.toUpperCase().replace(/[^0-9,.]/g, '').replace(',', '.');
        let multiplier = 1;
        if(strHarga.toUpperCase().includes('M')) multiplier = 1000000000;
        else if(strHarga.toUpperCase().includes('JT') || strHarga.toUpperCase().includes('JUTA')) multiplier = 1000000;
        let price = parseFloat(clean) * multiplier;

        if(isNaN(price) || price === 0) return null;

        let dpPercent = dpVal / 100;
        let dpAmount = price * dpPercent;
        let loanAmount = price - dpAmount;
        let rate = bungaVal / 100;
        let years = tenorVal;
        let months = years * 12;
        let monthlyRate = rate / 12;
        let installment = (loanAmount * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -months));

        const fmt = (num) => {
            if(num >= 1000000000) return (num/1000000000).toFixed(1) + " M";
            if(num >= 1000000) return (num/1000000).toFixed(0) + " Jt";
            return num.toLocaleString('id-ID');
        };

        return {
            dpPct: dpVal,
            dp: fmt(dpAmount),
            loan: fmt(loanAmount),
            rate: bungaVal,
            tenor: years,
            cicilan: (installment/1000000).toFixed(1) + " Jt/bln"
        };
    }

    function generateCaption() {
        const val = (id) => document.getElementById(id).value;
        const tone = document.getElementById('capTone').value;
        const platform = document.getElementById('capPlatform').value;
        const useKPR = document.getElementById('checkKPR').checked;
        const status = document.getElementById('status').value;
        const b = (txt) => platform === 'wa' ? `*${txt}*` : txt;
        const nl = `\n`; 

        let c = "";
        let locTag = val('lokasi').replace(/[^a-zA-Z]/g, '');
        let tags = `#${val('tipeProp')}Dijual #${locTag} #PropertiIndonesia #RealEstate`;
        if(val('lokasi').toLowerCase().includes('bsd')) tags += " #BSD #BSDCity #RumahBSD";
        if(val('lokasi').toLowerCase().includes('pik')) tags += " #PIK #PantaiIndahKapuk #RumahPIK";
        if(val('lokasi').toLowerCase().includes('jakarta')) tags += " #RumahJakarta #JualRumahJakarta";

        let specsBlock = `${b('SPESIFIKASI DETAIL:')}\n`;
        if(val('lt')) specsBlock += `üìê Luas Tanah: ${val('lt')} m¬≤\n`;
        if(val('lb')) specsBlock += `üè† Luas Bangunan: ${val('lb')} m¬≤\n`;
        if(val('kt')) specsBlock += `üõè Kamar Tidur: ${val('kt')}\n`;
        if(val('km')) specsBlock += `üöø Kamar Mandi: ${val('km')}\n`;
        if(val('legal')) specsBlock += `üìú Legalitas: ${val('legal')}\n`;
        if(val('listrik')) specsBlock += `‚ö° Listrik: ${val('listrik')} Watt\n`;
        if(val('air')) specsBlock += `üíß Air: ${val('air')}\n`;
        if(val('hadap')) specsBlock += `üß≠ Hadap: ${val('hadap')}\n`;
        if(val('furnish')) specsBlock += `üõã Furnish: ${val('furnish')}\n`;
        if(val('garasi')) specsBlock += `üöó Carport: ${val('garasi')} Mobil`;

        let pricingText = "";
        if(status === 'DIJUAL') {
             if(val('hargaCoret')) pricingText += `üîª TURUN HARGA DARI ${val('hargaCoret')}\n`;
             pricingText += `üí∞ ${b('HARGA: ' + val('hargaJual'))}`;
        } else if (status === 'DISEWA') {
             pricingText += `üí∞ ${b('HARGA SEWA: ' + val('hargaSewa'))}`;
        } else {
             if(val('hargaCoret')) pricingText += `üîª TURUN HARGA DARI ${val('hargaCoret')}\n`;
             pricingText += `üí∞ ${b('HARGA JUAL: ' + val('hargaJual'))}\n`;
             pricingText += `üîë ${b('HARGA SEWA: ' + val('hargaSewa'))}`;
        }

        let kprBlock = "";
        if(useKPR && status !== 'DISEWA') {
            let dataKPR = hitungDetailKPR(val('hargaJual'));
            if(dataKPR) {
                kprBlock = `${b('üè¶ SIMULASI KPR (Manual)')}\n`;
                kprBlock += `‚Ä¢ Harga Jual: ${val('hargaJual')}\n`;
                kprBlock += `‚Ä¢ DP ${dataKPR.dpPct}%: ¬± ${dataKPR.dp}\n`;
                kprBlock += `‚Ä¢ Bunga: ${dataKPR.rate}%\n`;
                kprBlock += `‚Ä¢ Plafon Pinjaman: ¬± ${dataKPR.loan}\n`;
                kprBlock += `‚Ä¢ ${b('Angsuran (' + dataKPR.tenor + ' Thn): ¬± ' + dataKPR.cicilan)}\n`;
            }
        }

        if(tone === 'formal') {
            c += `${b(val('judul').toUpperCase())}\n`;
            c += `Penawaran terbaik untuk ${val('tipeProp')} di kawasan ${val('lokasi')}.\n${nl}`;
            c += `${pricingText}\n${nl}`;
            c += `${specsBlock}\n${nl}`;
            if(val('poin')) c += `${b('KEUNGGULAN:')}\n${val('poin')}\n${nl}`;
            if(kprBlock) c += `${kprBlock}${nl}`;
            c += `Informasi lebih lanjut & jadwal survei hubungi:\n${b(val('nama'))}\n${val('kantor')}\nüìû ${val('hp')}`;

        } else if (tone === 'hype') {
            c += `üî• ${b(val('judul').toUpperCase())} üî•\n`;
            c += `Guys! Cek unit ${val('tipeProp')} kece di ${val('lokasi')} ini!\n${nl}`;
            c += `${pricingText} ‚ÄºÔ∏è\n${nl}`;
            c += `${specsBlock}\n${nl}`;
            c += `‚ú® ${val('poin')}\n${nl}`;
            if(kprBlock) c += `${kprBlock}${nl}`;
            c += `Jangan sampai lolos! Hubungi sekarang:\n${b(val('nama'))} - ${val('hp')}`;

        } else if (tone === 'story') {
            c += `${b('Hunian Impian di ' + val('lokasi') + ': ' + val('judul'))}\n${nl}`;
            c += `Temukan kenyamanan maksimal di properti ini. Dengan spesifikasi yang pas untuk keluarga:\n`;
            c += `${specsBlock}\n${nl}`;
            c += `${pricingText}\n`;
            if(kprBlock) c += `${nl}${kprBlock}${nl}`;
            c += `Miliki sekarang sebelum terlambat. Hubungi saya:\n${b(val('nama'))}\nüì≤ ${val('hp')}`;
        }

        c += `${nl}${nl}${tags}`;
        document.getElementById('finalCaption').value = c;
    }

    function rewriteCaptionAI() {
        if(userLicenseStatus !== 'PRO') {
            alert("üîí AI Rewrite hanya untuk PRO Member!");
            return;
        }

        // RESET: Generate ulang caption dasar agar tidak menumpuk emoji
        generateCaption(); 
        const currentText = document.getElementById('finalCaption').value;
        let newText = currentText;
        
        // Pilih gaya acak
        const styles = ['emoji-heavy', 'persuasive', 'urgent'];
        const randomStyle = styles[Math.floor(Math.random() * styles.length)];

        const emojiMap = {
            'RUMAH': 'üè†', 'RUKO': 'üè¢', 'TANAH': '‚õ≥', 'APARTEMEN': 'üè¢', 
            'DIJUAL': 'üî•', 'DISEWA': 'üîë', 'JAKARTA': 'üåÜ', 'BSD': 'üå≥',
            'SHM': '‚úÖ', 'LT': 'üìê', 'KT': 'üõèÔ∏è', 'KM': 'üöø', 'GARASI': 'üöó',
            'HARGA': 'üí∞', 'LOKASI': 'üìç', 'HUBUNGI': 'üìû'
        };
        
        if (randomStyle === 'emoji-heavy') {
            for (const [key, icon] of Object.entries(emojiMap)) {
                const regex = new RegExp(key, 'gi');
                // Hindari double emoji jika sudah ada
                if (!newText.includes(icon)) {
                    newText = newText.replace(regex, `${icon} ${key}`);
                }
            }
        } else if (randomStyle === 'urgent') {
             newText = "‚ö†Ô∏è BUTUH CEPAT LAKU! ‚ö†Ô∏è\n\n" + newText.replace("DIJUAL", "DIJUAL CEPAT (BU)");
        }

        document.getElementById('finalCaption').value = newText;
        alert("‚ú® Caption berhasil ditulis ulang dengan gaya: " + randomStyle.toUpperCase());
    }

    // --- REELS GENERATOR (UPGRADED) ---
    let mediaRecorder;
    let recordedChunks = [];

    async function generateReels() {
        const preview = document.getElementById('reelsPreview');
        const activeImages = propImages.filter(i => i !== null);
        
        if(activeImages.length < 2) {
            alert("Upload minimal 2 foto untuk membuat Reels!");
            return;
        }

        document.getElementById('loadingOverlay').style.display = 'flex';
        document.getElementById('loadingText').innerText = "Merender Video HD...";
        
        // Setup Canvas 9:16 (High Resolution)
        const canvas = document.createElement('canvas');
        canvas.width = 720;
        canvas.height = 1280;
        const ctx = canvas.getContext('2d');
        
        const stream = canvas.captureStream(30); 
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
        
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) recordedChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            preview.src = URL.createObjectURL(blob);
            preview.style.display = 'block';
            document.getElementById('loadingOverlay').style.display = 'none';
            
            // Auto Download
            const a = document.createElement('a');
            a.href = preview.src;
            a.download = `AgentPro-Reels-${Date.now()}.webm`;
            a.click();
        };

        mediaRecorder.start();

        // Load Asset
        const logo = new Image();
        if(localStorage.getItem('agentPro_img')) {
             logo.src = localStorage.getItem('agentPro_img');
             await new Promise(r => logo.onload = r).catch(()=>console.log("No Agent Img"));
        }

        const durationPerSlide = 2500; 
        const totalSlides = activeImages.length;
        const val = (id) => document.getElementById(id).value;
        
        for (let i = 0; i < totalSlides; i++) {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = activeImages[i];
            await new Promise(r => img.onload = r);
            
            const startTime = Date.now();
            while (Date.now() - startTime < durationPerSlide) {
                const elapsed = Date.now() - startTime;
                
                // Ken Burns Effect (Zoom In)
                const zoom = 1 + (elapsed / durationPerSlide) * 0.15; 
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.translate(canvas.width/2, canvas.height/2);
                ctx.scale(zoom, zoom);
                ctx.translate(-canvas.width/2, -canvas.height/2);
                
                // Draw Image Cover
                const hRatio = canvas.width / img.width;
                const vRatio = canvas.height / img.height;
                const ratio = Math.max(hRatio, vRatio);
                const centerShift_x = (canvas.width - img.width * ratio) / 2;
                const centerShift_y = (canvas.height - img.height * ratio) / 2;
                ctx.drawImage(img, 0, 0, img.width, img.height, centerShift_x, centerShift_y, img.width * ratio, img.height * ratio);
                ctx.restore();
                
                // --- OVERLAY KEREN ---
                // Gradient Bawah
                const gradient = ctx.createLinearGradient(0, canvas.height, 0, canvas.height - 600);
                gradient.addColorStop(0, "rgba(0,0,0,0.95)");
                gradient.addColorStop(1, "rgba(0,0,0,0)");
                ctx.fillStyle = gradient;
                ctx.fillRect(0, canvas.height - 600, canvas.width, 600);
                
                // Gradient Atas (untuk teks agen)
                const gradTop = ctx.createLinearGradient(0, 0, 0, 150);
                gradTop.addColorStop(0, "rgba(0,0,0,0.7)");
                gradTop.addColorStop(1, "rgba(0,0,0,0)");
                ctx.fillStyle = gradTop;
                ctx.fillRect(0, 0, canvas.width, 150);

                // TEXT INFO
                ctx.textAlign = "left";
                
                // Tipe Property
                ctx.fillStyle = "#FFD900";
                ctx.font = "bold 24px sans-serif";
                ctx.fillText(val('tipeProp') + " | " + val('status'), 40, canvas.height - 350);
                
                // Judul (Wrap Text)
                ctx.fillStyle = "#fff";
                ctx.font = "800 42px sans-serif";
                wrapText(ctx, val('judul').toUpperCase(), 40, canvas.height - 300, 640, 50);

                // Harga
                ctx.fillStyle = "#FFD900";
                ctx.font = "900 56px sans-serif";
                ctx.fillText("IDR " + val('hargaJual'), 40, canvas.height - 180);
                
                // Icons (LT, LB, KT, KM)
                drawSpecIcon(ctx, "üìê LT " + val('lt'), 40, canvas.height - 100);
                drawSpecIcon(ctx, "üè† LB " + val('lb'), 180, canvas.height - 100);
                drawSpecIcon(ctx, "üõèÔ∏è " + val('kt'), 320, canvas.height - 100);
                drawSpecIcon(ctx, "üöø " + val('km'), 420, canvas.height - 100);

                // AGENT BADGE (Top Left)
                if(logo.src) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(70, 70, 40, 0, Math.PI * 2, true);
                    ctx.closePath();
                    ctx.clip();
                    ctx.drawImage(logo, 30, 30, 80, 80);
                    ctx.restore();
                    // Border Agent
                    ctx.beginPath();
                    ctx.arc(70, 70, 40, 0, Math.PI * 2, true);
                    ctx.lineWidth = 4;
                    ctx.strokeStyle = "#FFD900";
                    ctx.stroke();
                }
                
                // Agent Text
                ctx.fillStyle = "#fff";
                ctx.font = "bold 28px sans-serif";
                ctx.fillText(val('nama'), 130, 65);
                ctx.font = "20px sans-serif";
                ctx.fillStyle = "#ccc";
                ctx.fillText(val('hp'), 130, 95);

                await new Promise(r => requestAnimationFrame(r));
            }
        }
        
        mediaRecorder.stop();
    }
    
    // Helper Wrap Text Canvas
    function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
        var words = text.split(' ');
        var line = '';
        var limit = 2; // Max lines
        var lineCount = 0;

        for(var n = 0; n < words.length; n++) {
          var testLine = line + words[n] + ' ';
          var metrics = ctx.measureText(testLine);
          var testWidth = metrics.width;
          if (testWidth > maxWidth && n > 0) {
            ctx.fillText(line, x, y);
            line = words[n] + ' ';
            y += lineHeight;
            lineCount++;
            if(lineCount >= limit) return; 
          } else {
            line = testLine;
          }
        }
        ctx.fillText(line, x, y);
    }
    
    function drawSpecIcon(ctx, text, x, y) {
        ctx.fillStyle = "rgba(255,255,255,0.2)";
        ctx.roundRect(x, y - 30, 120, 45, 10); // Chrome supported
        ctx.fill();
        ctx.fillStyle = "#fff";
        ctx.font = "bold 20px sans-serif";
        ctx.fillText(text, x + 10, y);
    }
    
    // Polyfill roundRect simple
    CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
      if (w < 2 * r) r = w / 2;
      if (h < 2 * r) r = h / 2;
      this.beginPath();
      this.moveTo(x+r, y);
      this.arcTo(x+w, y,   x+w, y+h, r);
      this.arcTo(x+w, y+h, x,   y+h, r);
      this.arcTo(x,   y+h, x,   y,   r);
      this.arcTo(x,   y,   x+w, y,   r);
      this.closePath();
      return this;
    }


    function loadAgentImg(e) { 
        const f = e.target.files[0]; 
        if(f) { const r = new FileReader(); r.onload = (ev) => { 
            const res = ev.target.result;
            document.getElementById('agEditPreview').src = res; 
            document.getElementById('agDisplay').src = res; 
            try { localStorage.setItem('agentPro_img', res); } catch(err) {} 
        }; r.readAsDataURL(f); } 
    }

    function loadProfile() { 
        const savedTxt = localStorage.getItem('agentPro_text'); 
        if(savedTxt) { 
            const d = JSON.parse(savedTxt); 
            if(d.nama && !document.getElementById('nama').value) document.getElementById('nama').value = d.nama; 
            if(d.hp && !document.getElementById('hp').value) document.getElementById('hp').value = d.hp; 
            if(d.kantor && !document.getElementById('kantor').value) document.getElementById('kantor').value = d.kantor; 
            if(d.wm) document.getElementById('wmCustomText').value = d.wm; 
            if(d.theme) {
                document.getElementById('themeColor').value = d.theme;
                applyTheme();
            }
        } 
        const savedImg = localStorage.getItem('agentPro_img'); if(savedImg) { 
            document.getElementById('agEditPreview').src = savedImg; 
            document.getElementById('agDisplay').src = savedImg; 
        } 
    }

    function adjustBrightness(val) { 
        globalBrightness = val;
        document.getElementById('brightVal').innerText = val; // Show number
        // LIVE PREVIEW: Apply filter to all grid images
        const imgs = document.querySelectorAll('.grid-item img');
        imgs.forEach(img => img.style.filter = `brightness(${val}%)`);
    }

    function autoScale() { 
        const c = document.getElementById('previewContainer'); 
        const s = document.getElementById('posterScaler'); 
        const cv = document.getElementById('posterCanvas'); 
        const sc = (c.offsetWidth - 30) / cv.offsetWidth; 
        s.style.transform = `scale(${sc > 1 ? 1 : sc})`; 
        c.style.marginBottom = `-${cv.offsetHeight * (1 - (sc > 1 ? 1 : sc))}px`; 
    }
    
    function setMode(m) { 
        document.getElementById('posterCanvas').className = m; 
        const style = document.getElementById('posterStyle').value;
        if(style === 'luxury') document.getElementById('posterCanvas').classList.add('luxury-theme');
        
        document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active')); 
        document.getElementById(m === 'feed' ? 'btnFeed' : 'btnStory').classList.add('active'); 
        setTimeout(() => { autoScale(); fitAllImages(); }, 100); 
    }

    function nav(t, el) { 
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); 
        document.getElementById('tab-'+t).classList.add('active'); 
        document.querySelectorAll('.nav-btn').forEach(n => n.classList.remove('active')); 
        el.classList.add('active'); 
        if(t === 'poster') setTimeout(() => { autoScale(); fitAllImages(); }, 200); 
    }

    function resetForm() { 
        if(confirm("Buat listing baru? Semua input akan dihapus.")) { 
            const inputs = document.querySelectorAll('input:not([type=file]):not([type=checkbox]), textarea');
            inputs.forEach(el => el.value = '');
            document.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
            propImages = [null, null, null, null];
            updateThumbnails();
            renderImages();
            loadProfile(); 
            renderAll();
        } 
    }
    
    function copyCaption() { 
        const t = document.getElementById('finalCaption'); 
        t.select(); 
        navigator.clipboard.writeText(t.value).then(() => alert("Caption tersalin!")); 
    }

    async function sharePoster() {
        if (!navigator.share) {
            alert("Fitur Share tidak didukung di browser/desktop ini. Gunakan tombol 'Simpan HD'.");
            return;
        }

        const scaler = document.getElementById('posterScaler');
        const overlay = document.getElementById('loadingOverlay');
        const wm = document.getElementById('watermarkLayer');
        const check = document.getElementById('checkWatermark').checked;
        const origT = scaler.style.transform;
        
        const imgs = document.querySelectorAll('.grid-item img');
        const filters = [];
        imgs.forEach(img => filters.push(img.style.filter));

        overlay.style.display = 'flex';
        scaler.style.transform = 'none';
        if(check) wm.style.display = 'flex';

        try {
            const canvas = await html2canvas(document.getElementById('posterCanvas'), { 
                scale: 3, 
                useCORS: true, 
                allowTaint: true,
                backgroundColor: null 
            });

            scaler.style.transform = origT; 
            imgs.forEach((img, i) => img.style.filter = filters[i]);
            if(check) wm.style.display = 'flex'; 

            canvas.toBlob(async (blob) => {
                const file = new File([blob], "poster-property.png", { type: "image/png" });
                const data = {
                    files: [file],
                    title: 'Info Properti',
                    text: document.getElementById('judul').value
                };

                try {
                    if (navigator.canShare && navigator.canShare(data)) {
                        await navigator.share(data);
                    } else {
                        alert("Browser tidak mengizinkan share gambar ini.");
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error("Share error:", err);
                        alert("Gagal membagikan gambar.");
                    }
                } finally {
                    overlay.style.display = 'none'; 
                }
            });

        } catch (e) {
            console.error(e);
            alert("Gagal memproses gambar untuk share.");
            scaler.style.transform = origT; 
            imgs.forEach((img, i) => img.style.filter = filters[i]);
            overlay.style.display = 'none';
        }
    }

    function downloadPoster() {
        const scaler = document.getElementById('posterScaler');
        const overlay = document.getElementById('loadingOverlay');
        const wm = document.getElementById('watermarkLayer');
        const check = document.getElementById('checkWatermark').checked;
        const origT = scaler.style.transform;
        
        const imgs = document.querySelectorAll('.grid-item img');
        const filters = [];
        imgs.forEach(img => filters.push(img.style.filter));

        overlay.style.display = 'flex';
        scaler.style.transform = 'none'; 
        
        if(check) wm.style.display = 'flex';
        
        setTimeout(() => {
            html2canvas(document.getElementById('posterCanvas'), { 
                scale: 4, 
                useCORS: true, 
                allowTaint: true,
                backgroundColor: null 
            })
            .then(canvas => {
                scaler.style.transform = origT; 
                if(check) wm.style.display = 'flex'; 
                imgs.forEach((img, i) => img.style.filter = filters[i]);
                overlay.style.display = 'none';

                const link = document.createElement('a');
                link.download = `AgentPro-${document.getElementById('judul').value || 'poster'}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
            }).catch(e => { 
                alert("Gagal render. Pastikan koneksi internet stabil untuk load aset gambar."); 
                console.error(e);
                scaler.style.transform = origT; 
                imgs.forEach((img, i) => img.style.filter = filters[i]);
                if(check) wm.style.display = 'flex';
                overlay.style.display = 'none';
            });
        }, 500); 
    }
</script>
</body>
</html>