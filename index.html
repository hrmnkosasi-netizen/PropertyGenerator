<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgentPro v9.7 - Smart Hide Specs</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- CSS UTAMA --- */
        :root {
            --primary: #FFD900; 
            --text-on-primary: #000000;
            --accent: #111;
            --text-main: #1f2937; 
            --text-muted: #6b7280; 
            --bg-body: #f3f4f6; 
            --bg-card: #ffffff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: #e5e7eb; font-family: 'Plus Jakarta Sans', sans-serif; display: flex; justify-content: center; height: 100dvh; color: var(--text-main); }
        
        .mobile-frame { width: 100%; max-width: 480px; background: var(--bg-body); height: 100%; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.15); }
        
        /* HEADER */
        .header { padding: 12px 15px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; z-index: 50; flex-shrink: 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .header h1 { margin: 0; font-size: 1rem; font-weight: 800; color: var(--accent); }
        .header h1 span { color: var(--primary); }
        .btn-reset { border:none; background: #fee2e2; color:#ef4444; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:0.8rem;}

        /* CONTENT AREA */
        .content { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 15px; padding-bottom: 90px; }
        .section { display: none; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .section.active { display: block; }
        @keyframes slideUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }

        /* CARDS & FORMS */
        .card { background: var(--bg-card); padding: 15px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card-head { font-weight: 700; font-size: 0.85rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: var(--accent); padding-bottom: 8px; border-bottom: 1px dashed #e5e7eb; }
        .form-group { margin-bottom: 10px; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; min-width: 0; }
        label { display: block; font-size: 0.7rem; font-weight: 600; color: var(--text-muted); margin-bottom: 4px; margin-left: 2px;}
        input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid transparent; border-radius: 10px; font-size: 0.9rem; font-family: inherit; font-weight: 500; background: #f9fafb; color: var(--text-main); transition: 0.2s; }
        input:focus, select:focus, textarea:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,0,0, 0.1); }
        
        .hidden-input { display: none; }

        /* MULTI IMAGE UPLOAD GRID */
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .upload-box { 
            aspect-ratio: 4/3; background: #e5e7eb; border-radius: 10px; overflow: hidden; position: relative; 
            border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .upload-box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .upload-box.has-img img { display: block; }
        .upload-box.has-img .placeholder { display: none; }
        .upload-box .placeholder { color: #888; font-size: 0.7rem; text-align: center; }
        .upload-box .placeholder i { font-size: 1.2rem; display: block; margin-bottom: 4px; }
        .upload-box .del-btn { 
            position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.8); color: white; 
            width: 20px; height: 20px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 0.6rem; z-index: 5;
        }
        .upload-box.has-img .del-btn { display: flex; }

        .img-cover { width: 100%; height: 100%; object-fit: cover; }
        
        /* POSTER AREA */
        .preview-container { width: 100%; display: flex; justify-content: center; align-items: flex-start; padding: 10px 0; overflow: hidden; }
        .poster-scaler { transform-origin: top center; transition: transform 0.3s ease; box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        
        #posterCanvas { background: #fff; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        #posterCanvas.feed { width: 360px; height: 450px; } 
        #posterCanvas.story { width: 320px; height: 568px; }

        .canvas-img-area { 
            position: relative; width: 100%; background: #eee; overflow: hidden;
            display: grid; gap: 2px; background: #fff; 
        }
        #posterCanvas.feed .canvas-img-area { height: 70%; }
        #posterCanvas.story .canvas-img-area { height: 75%; }

        /* GRID VARIANTS */
        .layout-1 { grid-template-columns: 1fr; grid-template-rows: 1fr; }
        .layout-2 { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
        .layout-3 { grid-template-columns: 1fr 1fr; grid-template-rows: 2fr 1fr; }
        .layout-3 .grid-item:nth-child(1) { grid-column: 1 / 3; } 
        .layout-4 { grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 2fr 1fr; }
        .layout-4 .grid-item:nth-child(1) { grid-column: 1 / 4; } 

        .grid-item { position: relative; overflow: hidden; background: #ddd; }
        .grid-item img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        /* --- COMPACT PRICE PILL --- */
        .price-badge-container { 
            position: absolute; top: 20px; right: 0; z-index: 20; 
            display: flex; flex-direction: column; align-items: flex-end; gap: 4px; 
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
            padding-right: 0;
        }
        
        .price-row {
            display: flex; align-items: stretch; border-radius: 8px 0 0 8px;
            overflow: hidden; height: 28px; 
        }
        
        .pr-label {
            background: var(--primary); color: var(--text-on-primary); font-weight: 800;
            font-size: 0.6rem; padding: 0 8px; display: flex; align-items: center; text-transform: uppercase;
        }
        .pr-label.sewa { background: #f3f4f6; color: #111; }

        .pr-val {
            background: #fff; color: #000; font-weight: 800; font-size: 0.8rem;
            padding: 0 10px; display: flex; align-items: center; letter-spacing: -0.5px;
        }

        .price-strike { 
            background: #ef4444; color: #fff; font-size: 0.6rem; font-weight: 700; 
            padding: 2px 8px; border-radius: 6px 0 0 6px; text-decoration: line-through; 
            display: none; margin-right: 0; margin-bottom: -4px;
        }

        /* STATUS BADGE */
        .status-badge {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg);
            border: 6px solid #fff; padding: 10px 30px; font-size: 2.5rem; font-weight: 900;
            color: #fff; background: rgba(220, 38, 38, 0.8); text-transform: uppercase; letter-spacing: 3px;
            z-index: 15; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center;
        }

        .watermark { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; pointer-events: none; opacity: 0.25; transform: rotate(-15deg); z-index: 10; }
        .watermark span { font-size: 3rem; font-weight: 900; color: #fff; border: 4px solid #fff; padding: 10px 20px; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); box-shadow: 0 2px 10px rgba(0,0,0,0.5); }

        /* INFO AREA LAYOUT */
        .canvas-info-area { flex: 1; background: #fff; padding: 12px 15px; display: flex; flex-direction: column; justify-content: space-between; position: relative; z-index: 20; }
        
        .prop-indicator { font-size: 0.65rem; font-weight: 800; color: var(--primary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 2px; display: flex; align-items: center; gap: 5px; }
        
        .info-title { 
            font-weight: 900; font-size: 1rem; line-height: 1.1; text-transform: uppercase; color: #111; 
            margin-bottom: 2px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        
        .info-loc { font-size: 0.7rem; color: #666; display: flex; gap: 4px; align-items: center; font-weight: 500; margin-bottom: 8px;}
        
        /* SPECS GRID - FIXED FOR HIDING */
        .specs-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px 0; padding: 6px 0; margin: 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }
        /* Removed nth-child border rule to avoid ugly borders when hiding items */
        .spec-box { text-align: center; border-right: 1px solid #eee; padding: 2px 0; display: block; }
        
        .spec-val { font-weight: 800; font-size: 0.7rem; color: #222; display:flex; justify-content:center; gap:2px; align-items:center; }
        .spec-val i { font-size: 0.6rem; color: #999; }
        .spec-label { font-size: 0.45rem; color: #888; text-transform: uppercase; font-weight: 600; margin-top: 1px; letter-spacing: -0.2px; }

        /* AGENT BAR */
        .agent-bar { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-top: 6px; }
        .agent-profile { display: flex; align-items: center; gap: 8px; flex: 1; overflow: hidden; }
        .agent-pic-box { width: 38px; height: 38px; border-radius: 50%; border: 1px solid var(--primary); flex-shrink: 0; overflow: hidden; background: #eee; }
        .agent-text h4 { margin: 0; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; line-height: 1.1; }
        .agent-text p { margin: 1px 0 0 0; font-size: 0.6rem; color: #666; }
        .agent-phone { font-size: 0.7rem; color: #111; font-weight: 700; display: flex; align-items: center; gap: 4px; margin-top: 1px; }
        .agent-phone i { color: #25D366; }
        .qr-wrapper { width: 38px; height: 38px; padding: 2px; border: 1px solid #eee; border-radius: 4px; background:#fff; flex-shrink: 0;}
        .qr-wrapper img { width: 100%; height: 100%; object-fit: contain; }

        /* NAVIGATION & UI */
        .nav-bar { position: absolute; bottom: 0; width: 100%; height: 70px; background: #fff; border-top: 1px solid #eee; display: flex; z-index: 40; padding-bottom: 10px; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.65rem; color: #9ca3af; cursor: pointer; transition: 0.2s; font-weight: 600; }
        .nav-btn.active { color: #111; }
        .nav-btn.active i { color: var(--primary); transform: translateY(-2px); }
        .nav-btn i { font-size: 1.2rem; margin-bottom: 4px; }
        
        .btn-action { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 12px; font-weight: 700; font-size: 0.9rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); transition: 0.2s; }
        .segment-control { display: flex; background: #e5e7eb; padding: 3px; border-radius: 10px; margin-bottom: 15px; }
        .segment-btn { flex: 1; padding: 8px; text-align: center; border: none; background: transparent; font-weight: 600; font-size: 0.8rem; cursor: pointer; border-radius: 8px; color: #666; transition: 0.2s; }
        .segment-btn.active { background: #fff; color: #000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .cap-tools { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .cap-opt { background: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid #e5e7eb; }
        .cap-opt label { font-size: 0.7rem; color: #666; display: block; margin-bottom: 5px; }
        .cap-opt select, .cap-opt button { width: 100%; font-size: 0.8rem; padding: 6px; }

        .kpr-input-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .kpr-box { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 10px; border-radius: 8px; text-align: center; }
        .kpr-box label { color: #166534; font-size: 0.65rem; margin-bottom: 4px; display: block; }
        .kpr-box input { text-align: center; padding: 5px; font-weight: bold; color: #15803d; border: 1px solid #86efac; background: #fff; }

        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px); background: #111; color: #fff; padding: 8px 20px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; opacity: 0; transition: 0.4s; z-index: 100; pointer-events: none; display: flex; align-items: center; gap: 8px; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200;
            display: none; justify-content: center; align-items: center; flex-direction: column; color: white;
        }

        .slider-box {
            background: #fff; padding: 10px 15px; border-radius: 12px; 
            margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex; align-items: center; gap: 10px;
        }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
    <div style="font-weight: 600;">Memproses HD...</div>
</div>

<div class="mobile-frame">
    <div class="header">
        <h1>Agent<span>Pro</span> <span style="font-size:0.6rem; color:#999;">v9.7 Smart Specs</span></h1>
        <button class="btn-reset" onclick="resetData()"><i class="fas fa-trash-alt"></i></button>
    </div>
    <div id="toast" class="toast"><i class="fas fa-check-circle" style="color:var(--primary)"></i> Tersimpan</div>

    <div class="content">
        
        <div id="tab-edit" class="section active">
             <div class="card">
                <div class="card-head"><i class="fas fa-paint-brush"></i> Branding & Status</div>
                <div class="cap-tools">
                    <div class="cap-opt">
                        <label>Tema Warna</label>
                        <select id="themeColor" onchange="applyTheme()">
                            <option value="yellow">üü° Kuning</option>
                            <option value="red">üî¥ Merah (ERA)</option>
                            <option value="blue">üîµ Biru (Remax)</option>
                            <option value="green">üü¢ Hijau (Promex)</option>
                            <option value="gold">üèÜ Gold (Century)</option>
                        </select>
                    </div>
                    <div class="cap-opt">
                        <label>Stempel Status</label>
                        <select id="statusBadge" onchange="renderAll()">
                            <option value="">- Kosong -</option>
                            <option value="TERJUAL">‚úÖ TERJUAL</option>
                            <option value="TERSEWA">üîë TERSEWA</option>
                            <option value="BOOKED">üìù BOOKED</option>
                            <option value="TURUN HARGA">üîª TURUN HARGA</option>
                        </select>
                    </div>
                </div>
             </div>

            <div class="card">
                <div class="card-head"><i class="fas fa-images"></i> Foto Properti (Max 4)</div>
                <div class="upload-grid">
                    <div class="upload-box" id="box-0" onclick="triggerUpload(0)">
                        <div class="placeholder"><i class="fas fa-plus"></i>Foto Utama</div>
                        <img id="prev-0">
                        <div class="del-btn" onclick="removeImg(0, event)">√ó</div>
                    </div>
                    <div class="upload-box" id="box-1" onclick="triggerUpload(1)">
                        <div class="placeholder"><i class="fas fa-plus"></i>Foto 2</div>
                        <img id="prev-1">
                        <div class="del-btn" onclick="removeImg(1, event)">√ó</div>
                    </div>
                    <div class="upload-box" id="box-2" onclick="triggerUpload(2)">
                        <div class="placeholder"><i class="fas fa-plus"></i>Foto 3</div>
                        <img id="prev-2">
                        <div class="del-btn" onclick="removeImg(2, event)">√ó</div>
                    </div>
                    <div class="upload-box" id="box-3" onclick="triggerUpload(3)">
                        <div class="placeholder"><i class="fas fa-plus"></i>Foto 4</div>
                        <img id="prev-3">
                        <div class="del-btn" onclick="removeImg(3, event)">√ó</div>
                    </div>
                </div>
                <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFileSelect(event)">
                
                <div style="padding:0 15px 15px 15px;">
                    <div style="display:flex; gap:15px; border-top:1px dashed #eee;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; color:#333;"><input type="checkbox" id="checkWatermark" checked style="width:auto;"> üõ°Ô∏è Watermark</label>
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; color:#333;"><input type="checkbox" id="checkQR" checked onchange="renderAll()" style="width:auto;"> QR Code</label>
                    </div>
                    <div class="form-group" style="margin-top:10px;"><label>Teks Watermark</label><input type="text" id="wmCustomText" placeholder="Default: Nama Kantor" oninput="renderAll()"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-head"><i class="fas fa-home"></i> Detail Properti</div>
                <div class="form-group">
                    <label>Jenis Properti</label>
                    <select id="tipeProp" onchange="renderAll()">
                        <option value="RUMAH">RUMAH</option>
                        <option value="RUKO">RUKO</option>
                        <option value="TANAH">TANAH</option>
                        <option value="APARTEMEN">APARTEMEN</option>
                        <option value="GUDANG">GUDANG</option>
                        <option value="KANTOR">KANTOR</option>
                        <option value="VILLA">VILLA</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Status</label>
                    <select id="status" onchange="handleStatusChange()">
                        <option value="DIJUAL">DIJUAL (Hanya Jual)</option>
                        <option value="DISEWA">DISEWA (Hanya Sewa)</option>
                        <option value="JUAL/SEWA">JUAL & SEWA (Dua Harga)</option>
                    </select>
                </div>

                <div class="row form-group" id="priceContainer">
                    <div class="col" id="colJual">
                        <label>Harga Jual (M/Jt)</label>
                        <input type="text" id="hargaJual" value="RP 4.5 M" oninput="renderAll()" style="font-weight:700;" placeholder="Rp ...">
                    </div>
                    <div class="col hidden-input" id="colSewa">
                        <label>Harga Sewa (Jt/Thn)</label>
                        <input type="text" id="hargaSewa" value="RP 150 JT/THN" oninput="renderAll()" style="font-weight:700;" placeholder="Rp ...">
                    </div>
                </div>

                <div class="form-group"><label style="color:#ef4444;">Harga Coret (Hanya utk Jual)</label><input type="text" id="hargaCoret" placeholder="Opsional" oninput="renderAll()" style="background:#fef2f2; color:#ef4444;"></div>
                <div class="form-group"><label>Judul Headline</label><input type="text" id="judul" value="RUMAH MEWAH HOOK LOKASI STRATEGIS" oninput="renderAll()"></div>
                <div class="form-group"><label>Lokasi</label><input type="text" id="lokasi" value="BSD City, Tangerang" oninput="renderAll()"></div>
            </div>

            <div class="card">
                <div class="card-head"><i class="fas fa-sliders-h"></i> Spesifikasi</div>
                <div class="row form-group">
                    <div class="col"><label>LT (m¬≤)</label><input type="number" id="lt" value="160" oninput="renderAll()"></div>
                    <div class="col"><label>LB (m¬≤)</label><input type="number" id="lb" value="220" oninput="renderAll()"></div>
                    <div class="col"><label>KT</label><input type="number" id="kt" value="4" oninput="renderAll()"></div>
                    <div class="col"><label>KM</label><input type="number" id="km" value="3" oninput="renderAll()"></div>
                </div>
                <div class="row form-group">
                    <div class="col">
                        <label>Legal</label>
                        <select id="legal" onchange="renderAll()">
                            <option value="SHM">SHM</option>
                            <option value="HGB">HGB</option>
                            <option value="AJB">AJB</option>
                            <option value="PPJB">PPJB</option>
                            <option value="">- (Kosong) -</option>
                        </select>
                    </div>
                    <div class="col"><label>Watt</label><input type="text" id="listrik" value="3500" oninput="renderAll()"></div>
                </div>
                <div class="row form-group">
                    <div class="col">
                        <label>Hadap</label>
                        <select id="hadap" onchange="renderAll()">
                            <option>Utara</option><option>Selatan</option><option>Timur</option><option>Barat</option><option>Utr-Tmr</option><option>Utr-Brt</option><option>Slt-Tmr</option><option>Slt-Brt</option>
                            <option value="">- (Kosong) -</option>
                        </select>
                    </div>
                    <div class="col"><label>Air</label><input type="text" id="air" value="PDAM" oninput="renderAll()"></div>
                </div>
                
                <div class="row form-group">
                    <div class="col">
                        <label>Furnish</label>
                        <select id="furnish" onchange="renderAll()">
                            <option value="Semi">Semi</option><option value="Full">Full</option><option value="Kosong">Kosong</option>
                            <option value="">- (Kosong) -</option>
                        </select>
                    </div>
                    <div class="col"><label>Garasi/Carport</label><input type="number" id="garasi" value="2" oninput="renderAll()"></div>
                </div>
                 <div class="form-group"><label>Poin Plus</label><textarea id="poin" rows="2">Siap huni, bebas banjir, keamanan 24 jam</textarea></div>
            </div>
            
            <div class="card">
                <div class="card-head"><i class="fas fa-calculator"></i> Kalkulator KPR Manual</div>
                <div class="kpr-input-grid">
                     <div class="kpr-box"><label>DP (%)</label><input type="number" id="kprDP" value="20" oninput="generateCaption()"></div>
                     <div class="kpr-box"><label>Bunga (%)</label><input type="number" id="kprBunga" value="5" oninput="generateCaption()"></div>
                     <div class="kpr-box"><label>Tenor (Thn)</label><input type="number" id="kprTenor" value="15" oninput="generateCaption()"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-head"><i class="fas fa-user-circle"></i> Profil Agen</div>
                <div class="row">
                     <div class="col" style="flex:0.3">
                         <div style="width:100%; aspect-ratio:1; background:#f3f4f6; border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px dashed #ccc; overflow:hidden;" onclick="document.getElementById('fileAg').click()">
                            <img id="agEditPreview" class="img-cover" src="https://randomuser.me/api/portraits/men/32.jpg" crossorigin="anonymous">
                         </div>
                         <input type="file" id="fileAg" hidden accept="image/*" onchange="loadAgentImg(event)">
                     </div>
                     <div class="col">
                         <div class="form-group" style="margin-bottom:8px;"><label>Nama</label><input type="text" id="nama" value="Herman Kosasi" oninput="renderAll()"></div>
                         <div class="form-group" style="margin-bottom:0;"><label>WhatsApp</label><input type="tel" id="hp" value="081234567890" oninput="renderAll()"></div>
                     </div>
                </div>
                <div class="form-group" style="margin-top:10px;"><label>Nama Kantor</label><input type="text" id="kantor" value="Brighton Titanium PIK" oninput="renderAll()"></div>
            </div>
        </div>

        <div id="tab-poster" class="section">
            <div class="segment-control">
                <button class="segment-btn active" id="btnFeed" onclick="setMode('feed')">Feed (4:5)</button>
                <button class="segment-btn" id="btnStory" onclick="setMode('story')">Story (9:16)</button>
            </div>
            
            <div class="slider-box">
                <i class="fas fa-sun" style="color:var(--primary)"></i>
                <div style="flex:1; margin:0 10px;">
                     <label style="font-size:0.65rem; color:#888; margin-bottom:4px;">Kecerahan Foto (Live)</label>
                     <input type="range" style="width:100%; accent-color:var(--primary);" min="50" max="150" value="100" oninput="adjustBrightness(this.value)">
                </div>
                <span id="brightVal" style="font-size:0.7rem; font-weight:700; width:30px;">100</span>
            </div>

            <div class="preview-container" id="previewContainer">
                <div class="poster-scaler" id="posterScaler">
                    <div id="posterCanvas" class="feed">
                        
                        <div class="canvas-img-area layout-1" id="imgGrid">
                            
                            <div class="price-badge-container" id="dynamicPriceBox">
                                </div>

                            <div id="stampDisplay" class="status-badge">TERJUAL</div>
                            <div class="watermark" id="watermarkLayer"><span id="wmTextDisplay">BRIGHTON</span></div>
                        </div>

                        <div class="canvas-info-area">
                            <div>
                                <div class="prop-indicator" id="o_tipe_display">RUMAH</div>
                                <div class="info-title" id="o_judul">RUMAH MEWAH HOOK LOKASI STRATEGIS</div>
                                <div class="info-loc"><i class="fas fa-map-marker-alt" style="color:var(--primary)"></i> <span id="o_lokasi">BSD City</span></div>
                                
                                <div class="specs-grid">
                                    <div class="spec-box" id="box_lt"><div class="spec-val"><i class="fas fa-expand"></i> <span id="o_lt">160</span></div><div class="spec-label">LT</div></div>
                                    <div class="spec-box" id="box_lb"><div class="spec-val"><i class="fas fa-home"></i> <span id="o_lb">220</span></div><div class="spec-label">LB</div></div>
                                    <div class="spec-box" id="box_kt"><div class="spec-val"><i class="fas fa-bed"></i> <span id="o_kt">4</span></div><div class="spec-label">KT</div></div>
                                    <div class="spec-box" id="box_km"><div class="spec-val"><i class="fas fa-bath"></i> <span id="o_km">3</span></div><div class="spec-label">KM</div></div>
                                    <div class="spec-box" id="box_legal"><div class="spec-val"><i class="fas fa-file-contract"></i> <span id="o_legal">SHM</span></div><div class="spec-label">Legal</div></div>
                                    
                                    <div class="spec-box" id="box_listrik"><div class="spec-val"><i class="fas fa-bolt"></i> <span id="o_listrik">3500</span></div><div class="spec-label">Watt</div></div>
                                    <div class="spec-box" id="box_air"><div class="spec-val"><i class="fas fa-tint"></i> <span id="o_air">PAM</span></div><div class="spec-label">Air</div></div>
                                    <div class="spec-box" id="box_hadap"><div class="spec-val"><i class="fas fa-compass"></i> <span id="o_hadap">Utara</span></div><div class="spec-label">Hadap</div></div>
                                    <div class="spec-box" id="box_furnish"><div class="spec-val"><i class="fas fa-couch"></i> <span id="o_furnish">Semi</span></div><div class="spec-label">Furnish</div></div>
                                    <div class="spec-box" id="box_garasi"><div class="spec-val"><i class="fas fa-car"></i> <span id="o_garasi">2</span></div><div class="spec-label">Carport</div></div>
                                </div>
                            </div>

                            <div class="agent-bar">
                                <div class="agent-profile">
                                    <div class="agent-pic-box">
                                        <img id="agDisplay" class="img-cover" src="https://randomuser.me/api/portraits/men/32.jpg" crossorigin="anonymous">
                                    </div>
                                    <div class="agent-text">
                                        <h4 id="o_nama">HERMAN KOSASI</h4>
                                        <p id="o_kontak">Brighton Titanium PIK</p>
                                        <span id="o_hp_display" class="agent-phone"><i class="fab fa-whatsapp"></i> 081234567890</span>
                                    </div>
                                </div>
                                <div class="qr-wrapper" id="qrBox"><img id="qrImage" src="" alt="QR"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <button class="btn-action" onclick="downloadPoster()"><i class="fas fa-download"></i> Download HD Poster</button>
        </div>

        <div id="tab-caption" class="section">
            <div class="card">
                <div class="card-head"><i class="fas fa-robot"></i> Smart Generator</div>
                <div class="cap-tools">
                    <div class="cap-opt">
                        <label>Gaya Bahasa</label>
                        <select id="capTone" onchange="generateCaption()">
                            <option value="formal">üëî Formal</option>
                            <option value="hype">üî• Viral/Hype</option>
                            <option value="story">üìñ Storytelling</option>
                        </select>
                    </div>
                    <div class="cap-opt">
                        <label>Platform</label>
                        <select id="capPlatform" onchange="generateCaption()">
                            <option value="ig">Instagram</option>
                            <option value="wa">WhatsApp (Bold)</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom:15px; background:#f0f9ff; padding:10px; border-radius:8px; border:1px solid #bae6fd;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; color:#0369a1; font-weight:700; font-size:0.8rem;">
                        <input type="checkbox" id="checkKPR" onchange="generateCaption()" checked style="width:auto;"> 
                        üè¶ Gunakan Hasil Hitungan KPR Manual
                    </label>
                </div>
                <div class="card-head" style="margin-top:15px;"><i class="fas fa-align-left"></i> Hasil Caption</div>
                <textarea id="finalCaption" rows="18" readonly style="background:#fff; border:1px solid #eee; font-family:monospace; font-size:0.8rem;"></textarea>
                <button onclick="copyCaption()" class="btn-action" style="margin-top:15px; background:#333; font-size:0.8rem; padding:10px;"><i class="fas fa-copy"></i> Salin Teks</button>
            </div>
        </div>

    </div>

    <div class="nav-bar">
        <div class="nav-btn active" onclick="nav('edit', this)"><i class="fas fa-pen-nib"></i> Edit</div>
        <div class="nav-btn" onclick="nav('poster', this)"><i class="fas fa-image"></i> Poster</div>
        <div class="nav-btn" onclick="nav('caption', this)"><i class="fas fa-magic"></i> Caption</div>
    </div>
</div>

<script>
    let currentMode = 'feed';
    const themes = {
        'yellow': { primary: '#FFD900', text: '#000000' },
        'red': { primary: '#dc2626', text: '#ffffff' },
        'blue': { primary: '#2563eb', text: '#ffffff' },
        'green': { primary: '#16a34a', text: '#ffffff' },
        'gold': { primary: '#d4af37', text: '#ffffff' }
    };
    
    // IMAGE STORAGE (Array)
    let propImages = [null, null, null, null]; 
    let defaultImg = 'https://images.unsplash.com/photo-1600596542815-e328d4de4bf7?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80';
    let activeUploadSlot = 0;
    let globalBrightness = 100; // Store brightness value
    let qrDebounceTimer; // Timer for QR debounce

    window.onload = function() { loadProfile(); handleStatusChange(); autoScale(); setTimeout(fitAllImages, 500); };
    window.onresize = () => { autoScale(); fitAllImages(); };

    function applyTheme() {
        const themeKey = document.getElementById('themeColor').value;
        const theme = themes[themeKey];
        document.documentElement.style.setProperty('--primary', theme.primary);
        document.documentElement.style.setProperty('--text-on-primary', theme.text);
    }

    function triggerUpload(idx) {
        activeUploadSlot = idx;
        document.getElementById('fileInput').click();
    }

    function handleFileSelect(event) {
        const f = event.target.files[0];
        if(f) {
            const r = new FileReader();
            r.onload = (ev) => {
                propImages[activeUploadSlot] = ev.target.result;
                updateThumbnails();
                renderImages(); // Update grid
            };
            r.readAsDataURL(f);
        }
        document.getElementById('fileInput').value = ''; 
    }

    function removeImg(idx, e) {
        e.stopPropagation();
        propImages[idx] = null;
        updateThumbnails();
        renderImages();
    }

    function updateThumbnails() {
        for(let i=0; i<4; i++) {
            const box = document.getElementById('box-'+i);
            const img = document.getElementById('prev-'+i);
            if(propImages[i]) {
                box.classList.add('has-img');
                img.src = propImages[i];
            } else {
                box.classList.remove('has-img');
                img.src = '';
            }
        }
    }

    function renderImages() {
        const activeImgs = propImages.filter(img => img !== null);
        const container = document.getElementById('imgGrid');
        
        // Save elements that need to be preserved (badges, watermark)
        const priceBadge = document.getElementById('dynamicPriceBox');
        const stamp = document.getElementById('stampDisplay');
        const wm = document.getElementById('watermarkLayer');

        container.innerHTML = ''; 
        
        let count = activeImgs.length;
        if(count === 0) { count = 1; activeImgs.push(defaultImg); } 

        container.className = `canvas-img-area layout-${count}`;

        activeImgs.forEach((src, idx) => {
            const div = document.createElement('div');
            div.className = 'grid-item';
            // Apply current brightness immediately
            div.innerHTML = `<img id="gridImg-${idx}" src="${src}" crossorigin="anonymous" onload="manualFitSingle('gridImg-${idx}')" style="filter: brightness(${globalBrightness}%)">`;
            container.appendChild(div);
        });

        // Restore overlay elements
        if(priceBadge) container.appendChild(priceBadge);
        if(stamp) container.appendChild(stamp);
        if(wm) container.appendChild(wm);
        
        setTimeout(fitAllImages, 100);
    }

    function manualFitSingle(id) {
        const img = document.getElementById(id);
        if(!img) return;
        const container = img.parentElement;
        const cRatio = container.offsetWidth / container.offsetHeight;
        const iRatio = img.naturalWidth / img.naturalHeight;
        if (iRatio > cRatio) { img.style.width = 'auto'; img.style.height = '100%'; } 
        else { img.style.width = '100%'; img.style.height = 'auto'; }
    }

    function fitAllImages() {
        const imgs = document.querySelectorAll('.grid-item img');
        imgs.forEach(img => manualFitSingle(img.id));
    }

    function handleStatusChange() {
        const s = document.getElementById('status').value;
        const cJual = document.getElementById('colJual');
        const cSewa = document.getElementById('colSewa');
        
        if(s === 'DIJUAL') {
            cJual.classList.remove('hidden-input');
            cSewa.classList.add('hidden-input');
        } else if (s === 'DISEWA') {
            cJual.classList.add('hidden-input');
            cSewa.classList.remove('hidden-input');
        } else {
            // JUAL/SEWA
            cJual.classList.remove('hidden-input');
            cSewa.classList.remove('hidden-input');
        }
        renderAll();
    }

    function renderAll() {
        const val = (id) => document.getElementById(id).value;
        const status = document.getElementById('status').value;

        localStorage.setItem('agentPro_text', JSON.stringify({ nama: val('nama'), hp: val('hp'), kantor: val('kantor'), wm: val('wmCustomText'), theme: val('themeColor') }));

        const mapText = (src, dest) => { 
            const el = document.getElementById(dest);
            if(el) el.innerText = val(src); 
        };
        
        // COMPACT PRICING LOGIC
        const pJual = val('hargaJual');
        const pSewa = val('hargaSewa');
        const priceBox = document.getElementById('dynamicPriceBox');
        const oldPrice = val('hargaCoret');
        
        let htmlPrice = '';

        // Helper for Coret Style
        let strikeHTML = '';
        if(status !== 'DISEWA' && oldPrice && oldPrice.trim() !== "") {
            strikeHTML = `<div class="price-strike">${oldPrice}</div>`;
        }

        const pill = (label, val, type) => `
            <div class="price-row">
                <div class="pr-label ${type}">${label}</div>
                <div class="pr-val">${val}</div>
            </div>
        `;

        if(status === 'DIJUAL') {
            if(strikeHTML) htmlPrice += strikeHTML;
            htmlPrice += pill('DIJUAL', pJual, 'jual');
        } else if (status === 'DISEWA') {
            htmlPrice += pill('DISEWA', pSewa, 'sewa');
        } else {
            // Dual
            if(strikeHTML) htmlPrice += strikeHTML;
            htmlPrice += pill('DIJUAL', pJual, 'jual');
            htmlPrice += pill('DISEWA', pSewa, 'sewa');
        }
        priceBox.innerHTML = htmlPrice;

        mapText('judul', 'o_judul'); mapText('lokasi', 'o_lokasi');
        
        // SMART HIDE SPECIFICATIONS LOGIC
        const updateSpec = (srcId, destId, boxId) => {
            const valInput = val(srcId);
            const box = document.getElementById(boxId);
            const txt = document.getElementById(destId);

            // Hide if empty string or specific "0" for some if needed (treating "" as hide signal)
            if(!valInput || valInput.trim() === "" || valInput === "-") {
                box.style.display = 'none';
            } else {
                box.style.display = 'block';
                txt.innerText = valInput;
            }
        };

        updateSpec('lt', 'o_lt', 'box_lt');
        updateSpec('lb', 'o_lb', 'box_lb');
        updateSpec('kt', 'o_kt', 'box_kt');
        updateSpec('km', 'o_km', 'box_km');
        updateSpec('legal', 'o_legal', 'box_legal');
        updateSpec('listrik', 'o_listrik', 'box_listrik');
        updateSpec('air', 'o_air', 'box_air');
        updateSpec('hadap', 'o_hadap', 'box_hadap');
        updateSpec('furnish', 'o_furnish', 'box_furnish');
        updateSpec('garasi', 'o_garasi', 'box_garasi');
        
        document.getElementById('o_tipe_display').innerText = val('tipeProp');
        document.getElementById('o_nama').innerText = val('nama');
        document.getElementById('o_kontak').innerText = val('kantor');
        document.getElementById('o_hp_display').innerHTML = '<i class="fab fa-whatsapp"></i> ' + val('hp');

        const badgeTxt = val('statusBadge');
        const badgeEl = document.getElementById('stampDisplay');
        if(badgeEl) {
            if(badgeTxt) {
                badgeEl.style.display = 'block';
                badgeEl.innerText = badgeTxt;
                if(badgeTxt === 'TERSEWA' || badgeTxt === 'TERJUAL') badgeEl.style.background = 'rgba(220, 38, 38, 0.9)'; 
                else if(badgeTxt === 'BOOKED') badgeEl.style.background = 'rgba(234, 88, 12, 0.9)'; 
                else badgeEl.style.background = 'rgba(22, 163, 74, 0.9)';
            } else {
                badgeEl.style.display = 'none';
            }
        }

        const wmEl = document.getElementById('watermarkLayer');
        if(wmEl) wmEl.style.display = 'none'; // Only show when rendering
        const wmText = document.getElementById('wmTextDisplay');
        if(wmText) wmText.innerText = val('wmCustomText') || val('kantor').split(' ')[0].toUpperCase();

        generateQR(); // Debounced
        generateCaption();
    }

    // Debounced QR Generator
    function generateQR() {
        const showQR = document.getElementById('checkQR').checked;
        const qrBox = document.getElementById('qrBox');
        const hp = document.getElementById('hp').value;
        const qrImg = document.getElementById('qrImage');

        if(!showQR || !hp) {
            qrBox.style.display = 'none';
            return;
        }

        qrBox.style.display = 'block';
        clearTimeout(qrDebounceTimer);
        qrDebounceTimer = setTimeout(() => {
            let cleanHP = hp.replace(/[^0-9]/g, '');
            if(cleanHP.startsWith('0')) cleanHP = '62' + cleanHP.substring(1);
            qrImg.setAttribute('crossorigin', 'anonymous'); 
            qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://wa.me/${cleanHP}`;
        }, 1000); 
    }

    function hitungDetailKPR(strHarga) {
        let dpVal = parseFloat(document.getElementById('kprDP').value) || 20; 
        let bungaVal = parseFloat(document.getElementById('kprBunga').value) || 5; 
        let tenorVal = parseFloat(document.getElementById('kprTenor').value) || 15; 

        let clean = strHarga.toUpperCase().replace(/[^0-9,.]/g, '').replace(',', '.');
        let multiplier = 1;
        if(strHarga.toUpperCase().includes('M')) multiplier = 1000000000;
        else if(strHarga.toUpperCase().includes('JT') || strHarga.toUpperCase().includes('JUTA')) multiplier = 1000000;
        let price = parseFloat(clean) * multiplier;

        if(isNaN(price) || price === 0) return null;

        let dpPercent = dpVal / 100;
        let dpAmount = price * dpPercent;
        let loanAmount = price - dpAmount;
        let rate = bungaVal / 100;
        let years = tenorVal;
        let months = years * 12;
        let monthlyRate = rate / 12;
        let installment = (loanAmount * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -months));

        const fmt = (num) => {
            if(num >= 1000000000) return (num/1000000000).toFixed(1) + " M";
            if(num >= 1000000) return (num/1000000).toFixed(0) + " Jt";
            return num.toLocaleString('id-ID');
        };

        return {
            dpPct: dpVal,
            dp: fmt(dpAmount),
            loan: fmt(loanAmount),
            rate: bungaVal,
            tenor: years,
            cicilan: (installment/1000000).toFixed(1) + " Jt/bln"
        };
    }

    function generateCaption() {
        const val = (id) => document.getElementById(id).value;
        const tone = document.getElementById('capTone').value;
        const platform = document.getElementById('capPlatform').value;
        const useKPR = document.getElementById('checkKPR').checked;
        const status = document.getElementById('status').value;
        const b = (txt) => platform === 'wa' ? `*${txt}*` : txt;
        const nl = `\n`; 

        let c = "";
        let locTag = val('lokasi').replace(/[^a-zA-Z]/g, '');
        let tags = `#${val('tipeProp')}Dijual #${locTag} #PropertiIndonesia #RealEstate`;
        if(val('lokasi').toLowerCase().includes('bsd')) tags += " #BSD #BSDCity #RumahBSD";
        if(val('lokasi').toLowerCase().includes('pik')) tags += " #PIK #PantaiIndahKapuk #RumahPIK";
        if(val('lokasi').toLowerCase().includes('jakarta')) tags += " #RumahJakarta #JualRumahJakarta";

        // Smart Caption: Only show if not empty
        let specsBlock = `${b('SPESIFIKASI DETAIL:')}\n`;
        if(val('lt')) specsBlock += `üìê Luas Tanah: ${val('lt')} m¬≤\n`;
        if(val('lb')) specsBlock += `üè† Luas Bangunan: ${val('lb')} m¬≤\n`;
        if(val('kt')) specsBlock += `üõè Kamar Tidur: ${val('kt')}\n`;
        if(val('km')) specsBlock += `üöø Kamar Mandi: ${val('km')}\n`;
        if(val('legal')) specsBlock += `üìú Legalitas: ${val('legal')}\n`;
        if(val('listrik')) specsBlock += `‚ö° Listrik: ${val('listrik')} Watt\n`;
        if(val('air')) specsBlock += `üíß Air: ${val('air')}\n`;
        if(val('hadap')) specsBlock += `üß≠ Hadap: ${val('hadap')}\n`;
        if(val('furnish')) specsBlock += `üõã Furnish: ${val('furnish')}\n`;
        if(val('garasi')) specsBlock += `üöó Carport: ${val('garasi')} Mobil`;

        // Logic Harga untuk Caption
        let pricingText = "";
        if(status === 'DIJUAL') {
             if(val('hargaCoret')) pricingText += `üîª TURUN HARGA DARI ${val('hargaCoret')}\n`;
             pricingText += `üí∞ ${b('HARGA: ' + val('hargaJual'))}`;
        } else if (status === 'DISEWA') {
             pricingText += `üí∞ ${b('HARGA SEWA: ' + val('hargaSewa'))}`;
        } else {
             // Jual & Sewa
             if(val('hargaCoret')) pricingText += `üîª TURUN HARGA DARI ${val('hargaCoret')}\n`;
             pricingText += `üí∞ ${b('HARGA JUAL: ' + val('hargaJual'))}\n`;
             pricingText += `üîë ${b('HARGA SEWA: ' + val('hargaSewa'))}`;
        }

        let kprBlock = "";
        // Only calc KPR if Selling is involved
        if(useKPR && status !== 'DISEWA') {
            let dataKPR = hitungDetailKPR(val('hargaJual'));
            if(dataKPR) {
                kprBlock = `${b('üè¶ SIMULASI KPR (Manual)')}\n`;
                kprBlock += `‚Ä¢ Harga Jual: ${val('hargaJual')}\n`;
                kprBlock += `‚Ä¢ DP ${dataKPR.dpPct}%: ¬± ${dataKPR.dp}\n`;
                kprBlock += `‚Ä¢ Bunga: ${dataKPR.rate}%\n`;
                kprBlock += `‚Ä¢ Plafon Pinjaman: ¬± ${dataKPR.loan}\n`;
                kprBlock += `‚Ä¢ ${b('Angsuran (' + dataKPR.tenor + ' Thn): ¬± ' + dataKPR.cicilan)}\n`;
            }
        }

        if(tone === 'formal') {
            c += `${b(val('judul').toUpperCase())}\n`;
            c += `Penawaran terbaik untuk ${val('tipeProp')} di kawasan ${val('lokasi')}.\n${nl}`;
            c += `${pricingText}\n${nl}`;
            c += `${specsBlock}\n${nl}`;
            if(val('poin')) c += `${b('KEUNGGULAN:')}\n${val('poin')}\n${nl}`;
            if(kprBlock) c += `${kprBlock}${nl}`;
            c += `Informasi lebih lanjut & jadwal survei hubungi:\n${b(val('nama'))}\n${val('kantor')}\nüìû ${val('hp')}`;

        } else if (tone === 'hype') {
            c += `üî• ${b(val('judul').toUpperCase())} üî•\n`;
            c += `Guys! Cek unit ${val('tipeProp')} kece di ${val('lokasi')} ini!\n${nl}`;
            c += `${pricingText} ‚ÄºÔ∏è\n${nl}`;
            c += `${specsBlock}\n${nl}`;
            c += `‚ú® ${val('poin')}\n${nl}`;
            if(kprBlock) c += `${kprBlock}${nl}`;
            c += `Jangan sampai lolos! Hubungi sekarang:\n${b(val('nama'))} - ${val('hp')}`;

        } else if (tone === 'story') {
            c += `${b('Hunian Impian di ' + val('lokasi') + ': ' + val('judul'))}\n${nl}`;
            c += `Temukan kenyamanan maksimal di properti ini. Dengan spesifikasi yang pas untuk keluarga:\n`;
            c += `${specsBlock}\n${nl}`;
            c += `${pricingText}\n`;
            if(kprBlock) c += `${nl}${kprBlock}${nl}`;
            c += `Miliki sekarang sebelum terlambat. Hubungi saya:\n${b(val('nama'))}\nüì≤ ${val('hp')}`;
        }

        c += `${nl}${nl}${tags}`;
        document.getElementById('finalCaption').value = c;
    }

    function loadAgentImg(e) { 
        const f = e.target.files[0]; 
        if(f) { const r = new FileReader(); r.onload = (ev) => { 
            const res = ev.target.result;
            document.getElementById('agEditPreview').src = res; 
            document.getElementById('agDisplay').src = res; 
            try { localStorage.setItem('agentPro_img', res); } catch(err) {} 
        }; r.readAsDataURL(f); } 
    }

    function loadProfile() { 
        const savedTxt = localStorage.getItem('agentPro_text'); 
        if(savedTxt) { 
            const d = JSON.parse(savedTxt); 
            if(d.nama) document.getElementById('nama').value = d.nama; 
            if(d.hp) document.getElementById('hp').value = d.hp; 
            if(d.kantor) document.getElementById('kantor').value = d.kantor; 
            if(d.wm) document.getElementById('wmCustomText').value = d.wm; 
            if(d.theme) {
                document.getElementById('themeColor').value = d.theme;
                applyTheme();
            }
        } 
        const savedImg = localStorage.getItem('agentPro_img'); if(savedImg) { 
            document.getElementById('agEditPreview').src = savedImg; 
            document.getElementById('agDisplay').src = savedImg; 
        } 
    }

    function adjustBrightness(val) { 
        globalBrightness = val;
        document.getElementById('brightVal').innerText = val; // Show number
        // LIVE PREVIEW: Apply filter to all grid images
        const imgs = document.querySelectorAll('.grid-item img');
        imgs.forEach(img => img.style.filter = `brightness(${val}%)`);
    }

    function autoScale() { 
        const c = document.getElementById('previewContainer'); 
        const s = document.getElementById('posterScaler'); 
        const cv = document.getElementById('posterCanvas'); 
        const sc = (c.offsetWidth - 30) / cv.offsetWidth; 
        s.style.transform = `scale(${sc > 1 ? 1 : sc})`; 
        c.style.marginBottom = `-${cv.offsetHeight * (1 - (sc > 1 ? 1 : sc))}px`; 
    }
    
    function setMode(m) { 
        document.getElementById('posterCanvas').className = m; 
        document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active')); 
        document.getElementById(m === 'feed' ? 'btnFeed' : 'btnStory').classList.add('active'); 
        setTimeout(() => { autoScale(); fitAllImages(); }, 100); 
    }

    function nav(t, el) { 
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); 
        document.getElementById('tab-'+t).classList.add('active'); 
        document.querySelectorAll('.nav-btn').forEach(n => n.classList.remove('active')); 
        el.classList.add('active'); 
        if(t === 'poster') setTimeout(() => { autoScale(); fitAllImages(); }, 200); 
    }

    function resetData() { 
        if(confirm("Hapus semua data?")) { localStorage.clear(); location.reload(); } 
    }
    
    function copyCaption() { 
        const t = document.getElementById('finalCaption'); 
        t.select(); 
        navigator.clipboard.writeText(t.value).then(() => alert("Caption tersalin!")); 
    }

    function downloadPoster() {
        const scaler = document.getElementById('posterScaler');
        const overlay = document.getElementById('loadingOverlay');
        const wm = document.getElementById('watermarkLayer');
        const check = document.getElementById('checkWatermark').checked;
        const origT = scaler.style.transform;
        
        // Store filters because html2canvas sometimes clears them
        const imgs = document.querySelectorAll('.grid-item img');
        const filters = [];
        imgs.forEach(img => filters.push(img.style.filter));

        overlay.style.display = 'flex';
        scaler.style.transform = 'none'; 
        if(check) wm.style.display = 'flex';
        
        setTimeout(() => {
            html2canvas(document.getElementById('posterCanvas'), { 
                scale: 4, 
                useCORS: true, 
                allowTaint: true,
                backgroundColor: null 
            })
            .then(canvas => {
                scaler.style.transform = origT; 
                wm.style.display = 'none';
                imgs.forEach((img, i) => img.style.filter = filters[i]);
                overlay.style.display = 'none';

                const link = document.createElement('a');
                link.download = `AgentPro-${document.getElementById('judul').value}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
            }).catch(e => { 
                alert("Gagal render. Pastikan koneksi internet stabil untuk load aset gambar."); 
                console.error(e);
                scaler.style.transform = origT; 
                imgs.forEach((img, i) => img.style.filter = filters[i]);
                wm.style.display = 'none';
                overlay.style.display = 'none';
            });
        }, 500); 
    }
</script>
</body>
</html>